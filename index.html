<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit System Pro - Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tom Select for Searchable Dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Sarabun', 'sans-serif'],
                        display: ['Prompt', 'sans-serif']
                    },
                    colors: {
                        primary: '#2563eb', secondary: '#1e293b', accent: '#3b82f6',
                        success: '#059669', warning: '#d97706', danger: '#dc2626',
                        surface: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-link.active { background-color: rgba(255, 255, 255, 0.1); border-left: 4px solid #60a5fa; }

        /* Tom Select Customization */
        .ts-control { border-radius: 0.5rem; padding: 10px 14px; border-color: #cbd5e1; font-family: 'Sarabun', sans-serif; }
        .ts-control:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .ts-dropdown { border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; }

        /* Form Styles */
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); 
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .card-header {
            background: #fff; padding: 16px 24px; border-bottom: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 12px;
        }
        .card-title { font-family: 'Prompt', sans-serif; font-size: 1.125rem; font-weight: 600; color: #1e293b; }
        .card-body { padding: 24px; }

        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 6px; }
        .input-box {
            width: 100%; padding: 10px 14px; background-color: #fff;
            border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; color: #334155; transition: all 0.2s;
        }
        .input-box:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); outline: none; }
        .input-box:read-only { background-color: #f8fafc; color: #64748b; cursor: not-allowed; }

        .rating-table-container { border: 1px solid #e2e8f0; border-radius: 8px; overflow-x: auto; }
        .rating-table { width: 100%; border-collapse: collapse; }
        .rating-table th { background-color: #f8fafc; padding: 12px; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; text-align: center; border-bottom: 1px solid #e2e8f0; }
        .rating-table th.text-left { text-align: left; }
        .rating-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .rating-table tr:last-child td { border-bottom: none; }
        .rating-topic { font-weight: 500; color: #334155; min-width: 150px; }
        
        .radio-cell { text-align: center; }
        .custom-radio { appearance: none; width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 50%; cursor: pointer; position: relative; transition: all 0.2s; margin: 0 auto; display: block; }
        .custom-radio:checked { border-color: #2563eb; background-color: #2563eb; }
        .custom-radio:checked::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%; }
        .custom-radio:hover { border-color: #94a3b8; }

        .check-item { display: flex; flex-direction: column; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 12px; transition: all 0.2s; }
        .check-item:hover { border-color: #cbd5e1; background: #fff; }
        
        .segmented-control { display: flex; background: #e2e8f0; padding: 4px; border-radius: 8px; width: fit-content; }
        .segment-radio { display: none; }
        .segment-label { padding: 6px 16px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; cursor: pointer; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .segment-radio[value="‡∏ú‡πà‡∏≤‡∏ô"]:checked + .segment-label { background: #059669; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .segment-radio[value="‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"]:checked + .segment-label { background: #dc2626; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .loader { width: 48px; height: 48px; display: inline-block; position: relative; }
        .loader::after, .loader::before { content: ''; width: 48px; height: 48px; border: 2px solid #FFF; position: absolute; left: 0; top: 0; box-sizing: border-box; animation: rotation 2s ease-in-out infinite; }
        .loader::after { border-color: #FF3D00; animation-delay: 1s; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .multi-select-container { position: relative; }
        .multi-select-dropdown { display: none; position: absolute; top: 100%; left: 0; z-index: 50; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); width: 220px; padding: 8px; max-height: 300px; overflow-y: auto; }
        .multi-select-dropdown.show { display: block; }
        
        #detailContent { font-family: 'Sarabun', sans-serif; color: #000; background: white; }
        #detailContent .text-sm { font-size: 11px !important; }
        #detailContent h2 { font-size: 16px !important; margin-bottom: 2px !important; }
        #detailContent h4 { font-size: 13px !important; margin-top: 8px !important; margin-bottom: 4px !important; border-bottom-width: 1px !important; }
        #detailContent .mb-6 { margin-bottom: 8px !important; }
        #detailContent .mb-4 { margin-bottom: 5px !important; }
        #detailContent .mt-8 { margin-top: 10px !important; }
        #detailContent .p-4 { padding: 8px !important; }
        #detailContent .gap-6 { gap: 8px !important; }
        #detailContent .gap-4 { gap: 8px !important; }
        #detailContent table { width: 100%; border-collapse: collapse; margin-bottom: 6px; table-layout: fixed; }
        #detailContent table th, #detailContent table td { padding: 2px 4px !important; font-size: 10px !important; border: 1px solid #94a3b8; }
        #detailContent table th { background-color: #f1f5f9; text-align: center; font-weight: bold; }
        #detailContent table td.text-center.font-bold.text-green-600.text-lg { font-size: 12px !important; }
        #detailContent img { max-height: 200px !important; width: auto; object-fit: contain; }
        #detailContent .h-16 { height: 50px !important; }
        #detailContent .h-20 { height: 200px !important; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen overflow-hidden flex flex-col" onclick="closeMultiSelect(event)">

    <div id="print-area" class="hidden bg-white text-black p-10"></div>

    <!-- Login View -->
    <div id="view-login" class="fixed inset-0 z-50 flex bg-white fade-in">
        <div class="hidden lg:flex w-1/2 bg-slate-900 relative items-center justify-center overflow-hidden">
            <div class="absolute inset-0 opacity-20">
                <i class="fa-solid fa-chart-line text-[20rem] absolute -bottom-20 -left-20 text-white transform rotate-12"></i>
                <i class="fa-solid fa-shield-halved text-[15rem] absolute top-10 right-10 text-white opacity-50"></i>
            </div>
            <div class="relative z-10 text-center text-white px-10">
                <div class="mb-6 inline-block p-4 rounded-full bg-white/10 backdrop-blur-lg border border-white/20 shadow-2xl">
                    <i class="fa-solid fa-database text-6xl text-green-400"></i>
                </div>
                <h1 class="text-4xl font-display font-bold mb-4 tracking-wide">Audit System Pro</h1>
                <p class="text-slate-300 text-lg max-w-md mx-auto leading-relaxed">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ Enterprise Grade</p>
                <div class="mt-8 flex justify-center gap-2">
                    <span class="px-3 py-1 bg-white/10 rounded-full text-xs border border-white/20">v 5.8.3 Enterprise</span>
                    <span class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-xs border border-green-500/30">‚óè Online</span>
                </div>
            </div>
        </div>
        <div class="w-full lg:w-1/2 flex items-center justify-center p-8 bg-slate-50">
            <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                <div class="mb-8 text-center lg:text-left">
                    <h2 class="text-3xl font-display font-bold text-slate-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <p class="text-slate-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Username</label>
                        <input type="text" id="loginUser" class="input-box" placeholder="Username" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                        <input type="password" id="loginPass" class="input-box" placeholder="Password" required>
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg shadow-lg transition transform active:scale-[0.98]">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                    <div class="text-center mt-4">
                        <div class="text-xs text-slate-400">Version 5.8.3 Enterprise</div>
                        <div class="text-[10px] text-slate-300 mt-1 font-bold">¬© 2026 ADMIN OK</div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="main-layout" class="hidden flex h-screen overflow-hidden bg-slate-100">
        <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden transition-opacity" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="appSidebar" class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col transition-transform duration-300 z-30 shadow-2xl fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0">
            <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800 justify-between md:justify-start">
                <div class="flex items-center">
                    <i class="fa-solid fa-shield-halved text-primary text-2xl mr-3"></i>
                    <span class="font-display font-bold text-lg tracking-wide">Audit Pro</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 border-b border-slate-800 bg-slate-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-primary to-accent flex items-center justify-center font-bold text-white shadow-lg border border-white/10">
                        <span id="sidebarAvatar">?</span>
                    </div>
                    <div class="overflow-hidden">
                        <p id="sidebarName" class="text-sm font-semibold truncate max-w-[120px]">User</p>
                        <p id="sidebarRole" class="text-xs text-slate-400 uppercase tracking-wider">-</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
                <a href="#" onclick="switchView('view-dashboard'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-chart-pie w-6 group-hover:text-primary transition-colors"></i><span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="switchView('view-audit'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-clipboard-check w-6 group-hover:text-success transition-colors"></i><span class="font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏Ç‡∏≤</span>
                </a>
                <a href="#" onclick="switchView('view-history'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-clock-rotate-left w-6 group-hover:text-warning transition-colors"></i><span class="font-medium">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</span>
                </a>
                <a href="#" onclick="switchView('view-settings'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-brands fa-line text-lg w-6 group-hover:text-green-400 transition-colors"></i><span class="font-medium">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                </a>
                <a href="#" onclick="openChangePasswordModal(); if(window.innerWidth < 768) toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-key w-6 group-hover:text-orange-400 transition-colors"></i><span class="font-medium">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
                </a>
                
                <!-- Admin Menu -->
                <div class="pt-4 pb-2 px-4 text-xs font-bold text-slate-500 uppercase tracking-widest admin-only hidden">Administrator</div>
                <a href="#" onclick="switchView('view-users'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link admin-only hidden flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-users-gear w-6 group-hover:text-purple-400 transition-colors"></i><span class="font-medium">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </a>
                <a href="#" onclick="switchView('view-questions'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-list-check w-6 group-hover:text-pink-400 transition-colors"></i><span class="font-medium">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</span>
                </a>
                <a href="#" onclick="switchView('view-logs'); if(window.innerWidth < 768) toggleSidebar();" class="nav-link admin-only hidden flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-file-shield w-6 group-hover:text-cyan-400 transition-colors"></i><span class="font-medium">System Logs</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-800 text-center">
                <div class="text-xs text-slate-500 font-bold mb-2 opacity-60">¬© 2026 ADMIN OK</div>
                <button type="button" onclick="logout()" class="w-full flex items-center justify-center gap-2 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white px-4 py-2 rounded-lg transition-all text-sm font-bold">
                    <i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full relative w-full transition-all duration-300">
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-4 sm:px-6 z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <button class="text-slate-500 hover:text-primary focus:outline-none p-1 rounded-md active:bg-slate-100 mr-2" onclick="toggleSidebar()"><i class="fa-solid fa-bars text-xl"></i></button>
                    <h2 id="pageTitle" class="text-lg sm:text-xl font-bold text-slate-800 truncate">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex items-center text-sm text-green-600 bg-green-50 px-3 py-1.5 rounded-full border border-green-200 shadow-sm"><i class="fa-solid fa-wifi mr-2 animate-pulse"></i><span id="connectionStatus">Online</span></div>
                    <button type="button" onclick="logout()" class="md:hidden w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-500 active:bg-red-100 ml-2"><i class="fa-solid fa-right-from-bracket text-sm"></i></button>
                </div>
            </header>

            <main id="mainContent" class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8 relative w-full bg-slate-50 pb-20">
                
                <!-- 1. Dashboard -->
                <div id="view-dashboard" class="page-view fade-in space-y-8">
                    
                    <!-- Dashboard Filters -->
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between relative mb-6">
                         <div class="font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-filter text-primary"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</div>
                         <div class="flex flex-wrap gap-3 w-full md:w-auto items-center">
                             
                             <select id="dashFilterYear" onchange="filterDashboardData(true)" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary cursor-pointer hover:bg-slate-100 font-bold">
                                 <!-- JS Generated -->
                             </select>

                             <div class="multi-select-container">
                                <button type="button" onclick="toggleMonthSelect(event, 'monthDropdown')" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 hover:bg-slate-100 flex items-center gap-2 min-w-[180px] justify-between">
                                    <span id="monthSelectLabel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                                    <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                                </button>
                                <div id="monthDropdown" class="multi-select-dropdown">
                                    <div class="flex items-center justify-between p-2 border-b border-slate-100 mb-1">
                                        <span class="text-xs font-bold text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                        <button onclick="selectAllMonths('dash')" class="text-xs text-primary hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                    </div>
                                    <div id="monthCheckboxes" class="space-y-1">
                                        <!-- JS Generated -->
                                    </div>
                                </div>
                             </div>

                             <select id="dashFilterZone" onchange="filterDashboardData(true)" class="w-full md:w-64">
                                 <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï (All Zones)</option>
                                 <!-- JS Generated -->
                             </select>
                         </div>
                    </div>

                    <div class="bg-gradient-to-r from-indigo-600 to-blue-500 rounded-2xl p-8 text-white shadow-lg relative overflow-hidden group">
                        <div class="relative z-10">
                            <h2 class="text-3xl font-bold font-display mb-2">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="dashWelcomeName">User</span> üëã</h2>
                            <p class="opacity-90 text-lg font-light">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤</p>
                        </div>
                        <i class="fa-solid fa-chart-line absolute -bottom-6 -right-6 text-white opacity-10 text-9xl transform -rotate-12 group-hover:scale-110 transition-transform duration-700"></i>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Stats Cards -->
                        <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all group">
                             <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-500"></div>
                             <div class="flex items-center justify-between relative z-10"><div><p class="text-sm font-medium text-slate-500">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><h3 id="dashTotalBranches" class="text-4xl font-display font-bold text-slate-800 mt-2">0</h3></div><div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-400 text-white flex items-center justify-center text-2xl"><i class="fa-solid fa-store"></i></div></div>
                        </div>
                        <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all group">
                             <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-500"></div>
                             <div class="flex items-center justify-between relative z-10"><div><p class="text-sm font-medium text-slate-500">‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</p><h3 id="dashAudited" class="text-4xl font-display font-bold text-emerald-600 mt-2">0</h3></div><div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-green-400 text-white flex items-center justify-center text-2xl"><i class="fa-solid fa-clipboard-check"></i></div></div>
                        </div>
                        <div onclick="showRemainingBranches()" class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all cursor-pointer group">
                             <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-500"></div>
                             <div class="flex items-center justify-between relative z-10"><div><p class="text-sm font-medium text-slate-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><h3 id="dashRemaining" class="text-4xl font-display font-bold text-orange-500 mt-2">0</h3></div><div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-orange-500 to-amber-400 text-white flex items-center justify-center text-2xl"><i class="fa-solid fa-hourglass-half"></i></div></div>
                        </div>
                        <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all group">
                             <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-gradient-to-br from-rose-500/20 to-red-500/20 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-500"></div>
                             <div class="flex items-center justify-between relative z-10"><div><p class="text-sm font-medium text-slate-500">‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p><h3 id="dashFailCount" class="text-4xl font-display font-bold text-rose-600 mt-2">0</h3></div><div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-rose-500 to-red-400 text-white flex items-center justify-center text-2xl"><i class="fa-solid fa-triangle-exclamation"></i></div></div>
                        </div>
                    </div>
                    <!-- Zone List -->
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden mt-8">
                        <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50"><h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg"><i class="fa-solid fa-map-location-dot text-primary"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï (Zone Status)</h3></div>
                        <div class="p-6 bg-slate-50/20"><div id="zoneStatList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 text-sm"><div class="col-span-full text-center py-10 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div></div>
                    </div>
                </div>

                <!-- 2. Audit Form -->
                <div id="view-audit" class="page-view fade-in hidden max-w-5xl mx-auto pb-20">
                    <div id="draftNotice" class="hidden mb-6 bg-amber-50 border border-amber-200 rounded-lg p-4 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3 text-amber-800"><i class="fa-solid fa-clock-rotate-left text-xl"></i><div><span class="font-bold">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á</span> <span class="text-sm">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</span></div></div>
                        <div class="flex gap-2"><button onclick="clearDraft()" class="px-3 py-1.5 text-slate-500 hover:text-slate-800 text-sm font-bold">‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á</button><button onclick="restoreDraft(JSON.parse(localStorage.getItem(STORAGE.DRAFT)))" class="px-4 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-md text-sm font-bold shadow-sm">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button></div>
                    </div>
                    <div class="mb-6 flex justify-between items-end"><div><h2 class="text-3xl font-display font-bold text-slate-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏Ç‡∏≤</h2><p class="text-slate-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p></div><div class="text-right hidden sm:block"><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Date</div><div class="text-slate-700 font-mono font-bold text-lg bg-white px-3 py-1 rounded shadow-sm border" id="headerDate">-</div></div></div>
                    <form id="auditForm" onsubmit="submitAudit(event)" oninput="saveDraft()">
                        <div class="card"><div class="card-header border-l-4 border-blue-500"><i class="fa-solid fa-store text-blue-500 text-lg"></i><h3 class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ (Branch Info)</h3></div><div class="card-body"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="lg:col-span-3 bg-blue-50 border border-blue-100 rounded-xl p-4 flex flex-col md:flex-row items-center gap-4"><div class="flex-1 w-full"><label class="input-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS <span class="text-red-500">*</span></label><div class="relative"><input type="text" id="gpsCoords" class="input-box font-mono pl-10" readonly placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Check-in"><i class="fa-solid fa-location-dot absolute left-3 top-3 text-blue-500"></i></div></div><button type="button" onclick="getLocation()" class="w-full md:w-auto px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm transition flex items-center justify-center gap-2"><i class="fa-solid fa-location-crosshairs"></i> Check-in</button></div><div class="input-group"><label class="input-label">‡πÄ‡∏Ç‡∏ï (Zone)</label><div class="relative"><select id="zoneSelect" onchange="handleZoneChange()" class="input-box appearance-none cursor-pointer w-full"><option value="">-- ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option></select></div></div><div class="input-group"><label class="input-label">‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)</label><div class="relative"><select id="branchSelect" class="input-box appearance-none cursor-pointer w-full disabled:bg-slate-100" disabled><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏Å‡πà‡∏≠‡∏ô --</option></select></div></div><div class="input-group"><label class="input-label">‡πÑ‡∏ã‡∏ï‡πå‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="text" id="f_site" class="input-box" placeholder="‡πÄ‡∏ä‡πà‡∏ô S, M, L"></div></div><div class="mt-4 pt-4 border-t border-slate-100 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="input-group"><label class="input-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target)</label><input type="number" id="f_target" oninput="calculatePerformance()" class="input-box" placeholder="0.00"></div><div class="input-group"><label class="input-label">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (Actual)</label><input type="number" id="f_actual" oninput="calculatePerformance()" class="input-box font-bold text-blue-600" placeholder="0.00"></div><div class="input-group"><label class="input-label">% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤</label><input type="text" id="f_percent" class="input-box bg-green-50 text-green-700 font-bold text-center" readonly placeholder="0%"></div></div><div class="mt-4 border-t border-slate-100 pt-4 grid grid-cols-2 md:grid-cols-4 gap-4"><div class="input-group"><label class="input-label">OD1 %</label><input type="text" id="f_od1" class="input-box" placeholder="%"></div><div class="input-group"><label class="input-label">OD2 %</label><input type="text" id="f_od2" class="input-box" placeholder="%"></div><div class="input-group"><label class="input-label">OD3 %</label><input type="text" id="f_od3" class="input-box" placeholder="%"></div><div class="input-group"><label class="input-label">NPL %</label><input type="text" id="f_npl_percent" class="input-box font-bold text-red-600" placeholder="%"></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-2"><div class="input-group"><label class="input-label">AR (‡∏ö‡∏≤‡∏ó)</label><input type="text" id="f_ar" oninput="calculateDebt()" onblur="formatInputCurrency(this)" class="input-box" placeholder="0.00"></div><div class="input-group"><label class="input-label">NET AR (‡∏ö‡∏≤‡∏ó)</label><input type="text" id="f_net_ar" oninput="calculateDebt()" onblur="formatInputCurrency(this)" class="input-box" placeholder="0.00"></div><div class="input-group"><label class="input-label">NPL (‡∏ö‡∏≤‡∏ó) <span class="text-xs font-normal text-slate-400">(AR - NET AR)</span></label><input type="text" id="f_npl_baht" class="input-box bg-slate-100 font-bold text-red-600" readonly placeholder="0.00"></div></div></div></div>
                        <div class="card">
                            <div class="card-header border-l-4 border-purple-500 flex justify-between items-center">
                                <div class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-purple-500 text-lg"></i><h3 class="card-title">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Employee)</h3></div>
                                <span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ñ‡∏ô</span>
                            </div>
                            <div class="card-body">
                                <div id="employeesContainer"></div>
                                <button type="button" onclick="addEmployee()" class="w-full mt-4 border-2 border-dashed border-purple-300 text-purple-600 bg-purple-50 hover:bg-purple-100 hover:border-purple-400 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                                </button>
                            </div>
                        </div>
                        <div class="card"><div class="card-header border-l-4 border-orange-500"><i class="fa-solid fa-broom text-orange-500 text-lg"></i><h3 class="card-title">‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≤‡∏Ç‡∏≤ (5‡∏™.)</h3></div><div class="card-body"><div class="rating-table-container mb-6"><table class="rating-table"><thead><tr><th class="text-left pl-4">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th><th width="60">1<br><span class="font-normal text-[10px]">‡πÅ‡∏¢‡πà</span></th><th width="60">2<br><span class="font-normal text-[10px]">‡∏û‡∏≠‡πÉ‡∏ä‡πâ</span></th><th width="60">3<br><span class="font-normal text-[10px]">‡πÄ‡∏â‡∏¢‡πÜ</span></th><th width="60">4<br><span class="font-normal text-[10px]">‡∏î‡∏µ</span></th><th width="60">5<br><span class="font-normal text-[10px]">‡∏î‡∏µ‡∏°‡∏≤‡∏Å</span></th></tr></thead><tbody><tr><td class="rating-topic pl-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤</td><td class="radio-cell"><input type="radio" name="rate_c_branch" value="1" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_branch" value="2" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_branch" value="3" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_branch" value="4" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_branch" value="5" class="custom-radio"></td></tr><tr><td class="rating-topic pl-4">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td><td class="radio-cell"><input type="radio" name="rate_c_desk" value="1" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_desk" value="2" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_desk" value="3" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_desk" value="4" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_desk" value="5" class="custom-radio"></td></tr><tr><td class="rating-topic pl-4">‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</td><td class="radio-cell"><input type="radio" name="rate_c_coffee" value="1" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_coffee" value="2" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_coffee" value="3" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_coffee" value="4" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_coffee" value="5" class="custom-radio"></td></tr><tr><td class="rating-topic pl-4">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥</td><td class="radio-cell"><input type="radio" name="rate_c_toilet" value="1" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_toilet" value="2" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_toilet" value="3" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_toilet" value="4" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_toilet" value="5" class="custom-radio"></td></tr><tr><td class="rating-topic pl-4">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á</td><td class="radio-cell"><input type="radio" name="rate_c_storage" value="1" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_storage" value="2" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_storage" value="3" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_storage" value="4" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_storage" value="5" class="custom-radio"></td></tr><tr><td class="rating-topic pl-4">‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</td><td class="radio-cell"><input type="radio" name="rate_c_back" value="1" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_back" value="2" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_back" value="3" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_back" value="4" class="custom-radio"></td><td class="radio-cell"><input type="radio" name="rate_c_back" value="5" class="custom-radio"></td></tr></tbody></table></div><div class="input-group"><label class="input-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (5‡∏™.)</label><textarea id="area_comment" rows="2" class="input-box" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ä‡∏°..."></textarea></div></div></div>
                        <div class="card"><div class="card-header border-l-4 border-pink-500"><i class="fa-solid fa-list-check text-pink-500 text-lg"></i><h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Checklist)</h3></div><div class="card-body" id="questionsContainer"><div class="text-center py-8 text-slate-400"><div class="loader mx-auto mb-3 border-slate-300"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</div></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"><div class="card h-full"><div class="card-header"><h3 class="card-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h3></div><div class="card-body h-full"><textarea id="summaryComment" class="input-box h-40 resize-none" placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢ ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..."></textarea></div></div><div class="card h-full"><div class="card-header flex justify-between"><h3 class="card-title">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</h3><button type="button" onclick="clearSignature()" class="text-xs text-red-500 font-bold hover:underline">‡∏•‡πâ‡∏≤‡∏á</button></div><div class="card-body"><div class="border border-dashed border-slate-300 rounded-lg overflow-hidden h-40 relative cursor-crosshair"><canvas id="signaturePad" class="w-full h-full absolute inset-0"></canvas><span class="absolute bottom-2 right-2 text-xs text-slate-300 pointer-events-none">‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span></div></div></div></div>
                        <div class="flex flex-col-reverse sm:flex-row gap-4 pt-4 border-t border-slate-200 mt-8"><button type="button" onclick="switchView('view-dashboard')" class="w-full sm:w-auto px-6 py-3 rounded-lg border border-slate-300 text-slate-600 font-bold hover:bg-slate-50 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="w-full sm:flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg shadow-blue-200 transition flex items-center justify-center gap-2 text-lg"><i class="fa-solid fa-paper-plane"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></div>
                    </form>
                </div>

                <!-- 3. History View -->
                <div id="view-history" class="page-view fade-in hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-4 sm:p-6 bg-white border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                             <h3 class="font-bold text-lg text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h3>
                             <div class="flex flex-wrap gap-2 w-full md:w-auto">
                                 <select id="histFilterMonth" onchange="filterHistoryTable(true)" class="bg-slate-50 text-sm border border-slate-200 rounded px-2 py-1.5 cursor-pointer">
                                     <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (All Months)</option>
                                     <!-- JS Generated -->
                                 </select>
                                 <select id="histFilterZone" onchange="handleHistZoneChange(true)" class="w-40">
                                     <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</option>
                                     <!-- JS Generated -->
                                 </select>
                                 <select id="histFilterBranch" onchange="filterHistoryTable(true)" class="w-40">
                                     <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                 </select>
                                 <button onclick="fetchHistory()" class="text-sm text-primary hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition"><i class="fa-solid fa-sync"></i></button>
                             </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="bg-slate-50 border-b uppercase text-xs font-bold text-slate-500"><tr><th class="px-6 py-4 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-6 py-4 whitespace-nowrap">‡∏™‡∏≤‡∏Ç‡∏≤</th><th class="px-6 py-4 whitespace-nowrap">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th><th class="px-6 py-4 whitespace-nowrap">‡∏ú‡∏•</th><th class="px-6 py-4 text-center whitespace-nowrap">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody id="auditLogContainer" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <!-- 4. Questions Config View -->
                <div id="view-questions" class="page-view fade-in hidden max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2"><i class="fa-solid fa-list-check text-pink-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏à‡∏≤‡∏Å Google Sheets)</h3>
                            <div class="flex items-center gap-3">
                                <button onclick="openAddQuestionModal()" class="flex items-center gap-2 bg-primary hover:bg-blue-700 text-white text-sm font-bold px-4 py-2 rounded-lg transition shadow-sm"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
                                <button onclick="fetchQuestionsFromAPI()" class="text-slate-400 hover:text-primary transition p-2"><i class="fa-solid fa-rotate"></i></button>
                            </div>
                        </div>
                        <div class="p-4 rounded-lg border border-blue-100 bg-blue-50 text-blue-800 text-sm mb-6 flex gap-3 items-center"><i class="fa-solid fa-circle-info text-xl"></i><div><span class="font-bold">Admin Notice:</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br><span class="text-xs opacity-75">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span></div></div>
                        <div id="questionsListConfig" class="space-y-3"></div>
                    </div>
                </div>

                <!-- 6. Notifications Settings / Guide -->
                <div id="view-settings" class="page-view fade-in hidden max-w-5xl mx-auto">
                    
                    <!-- User Guide Section (Visible to ALL) -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 md:p-10 mb-8">
                        <div class="flex flex-col md:flex-row gap-10">
                            <!-- Left: QR Code -->
                            <div class="w-full md:w-1/3 flex flex-col items-center justify-start border border-slate-100 rounded-2xl p-6 bg-slate-50/50">
                                <h4 class="font-bold text-slate-800 mb-6 text-lg">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 relative">
                                    <!-- üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR Code ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà src="..." ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ -->
                                    <img src="https://lh3.googleusercontent.com/d/1EmxRRC62H0O2phRp8F5rCCvNr8QaHndZ" alt="LINE QR Code" class="w-48 h-48 object-contain">
                                    <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                                        <i class="fa-brands fa-line text-[80px] text-[#00B900]"></i>
                                    </div>
                                </div>
                                <p class="text-sm text-slate-500 text-center leading-relaxed">‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô LINE ‡∏™‡πÅ‡∏Å‡∏ô QR Code<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                            </div>

                            <!-- Right: Guide Steps -->
                            <div class="w-full md:w-2/3">
                                <h3 class="font-bold text-slate-800 text-lg mb-8 flex items-center gap-2">
                                    <i class="fa-brands fa-line text-[#00B900] text-2xl"></i> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User Guide)
                                </h3>
                                
                                <div class="space-y-8 relative before:absolute before:inset-0 before:ml-4 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-200 before:to-transparent">
                                    
                                    <!-- Step 1 -->
                                    <div class="relative flex items-start gap-6">
                                        <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm shrink-0 z-10 shadow-md">1</div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-800 mb-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (Add Friend)</h4>
                                            <p class="text-sm text-slate-500 mb-3">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
                                            
                                            <!-- üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ (‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1) ‡∏ó‡∏µ‡πà src="..." ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ (‡∏´‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö div Step 1 ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) -->
                                            <img src="https://lh3.googleusercontent.com/d/1miVjWLx-kA7nNn0yhb44viOwbzfcLVOl" class="w-full max-w-sm rounded-lg border border-slate-200 shadow-sm">
                                            <div class="bg-slate-50 border border-slate-100 rounded-lg p-4 text-center text-xs text-slate-400 h-24 flex items-center justify-center font-mono">
                                                Step 1: Add Friend
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 2 -->
                                    <div class="relative flex items-start gap-6">
                                        <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm shrink-0 z-10 shadow-md">2</div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-800 mb-1">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Register)</h4>
                                            <p class="text-sm text-slate-500 mb-3">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ <span class="text-primary font-bold bg-blue-50 px-2 py-0.5 rounded border border-blue-100">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span> ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡∏ö‡∏≠‡∏ó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</p>
                                            
                                            <!-- üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ (‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2) ‡∏ó‡∏µ‡πà src="..." ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ -->
                                            <!-- <img src="‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà_2_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ" class="w-full max-w-sm rounded-lg border border-slate-200 shadow-sm"> -->
                                            <div class="bg-slate-50 border border-slate-100 rounded-lg p-4 text-center text-xs text-slate-400 h-24 flex items-center justify-center font-mono">
                                                Step 2: Type Register
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3 -->
                                    <div class="relative flex items-start gap-6">
                                        <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm shrink-0 z-10 shadow-md">3</div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-800 mb-1">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Success)</h4>
                                            <p class="text-sm text-slate-500 mb-3">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                                            
                                            <!-- üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 4: ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ (‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 3) ‡∏ó‡∏µ‡πà src="..." ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ -->
                                            <!-- <img src="‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà_3_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ" class="w-full max-w-sm rounded-lg border border-slate-200 shadow-sm"> -->
                                            <div class="bg-slate-50 border border-slate-100 rounded-lg p-4 text-center text-xs text-slate-400 h-24 flex items-center justify-center font-mono">
                                                Step 3: Confirmation
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Configuration Section (Hidden for normal users) -->
                    <div class="admin-only hidden bg-white rounded-2xl shadow-sm border border-slate-100 p-6 md:p-10 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-slate-50 rounded-bl-full -z-10"></div>
                        <h3 class="font-bold text-slate-800 text-lg mb-6 flex items-center gap-2 border-b border-slate-100 pb-4">
                            <i class="fa-solid fa-gears text-slate-400"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)
                        </h3>
                        <form onsubmit="handleSaveSettings(event)" class="space-y-6 max-w-2xl">
                            <div>
                                <label class="input-label">Line Notify Token</label>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="settingLineToken" class="input-box font-mono text-sm w-full" placeholder="Ex: xxxxxxxxxx">
                                    <a href="https://notify-bot.line.me/my/" target="_blank" class="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 flex items-center justify-center text-xs whitespace-nowrap transition shadow-sm font-bold">Get Token</a>
                                </div>
                            </div>
                            <div>
                                <label class="input-label">Email Notification</label>
                                <input type="email" id="settingEmail" class="input-box w-full" placeholder="admin@example.com">
                            </div>
                            <div class="pt-4">
                                <button type="submit" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold transition shadow-md flex items-center gap-2">
                                    <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 5. User Management -->
                <div id="view-users" class="page-view fade-in hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                             <h3 class="font-bold mb-4 border-l-4 border-primary pl-3 text-slate-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                             <form onsubmit="handleAddUser(event)" class="space-y-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Username</label><input name="newUsername" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Password</label><input name="newPassword" type="password" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Full Name</label><input name="newName" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Role</label><select name="newRole" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition"><option value="user">User (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</option><option value="admin">Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</option></select></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Permission Area</label><input name="newPermissionArea" placeholder="‡πÄ‡∏ä‡πà‡∏ô BKK,UPC ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå ALL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition"></div>
                                <button class="w-full bg-slate-800 text-white p-3 rounded-lg font-bold hover:bg-slate-700 transition mt-2"><i class="fa-solid fa-plus mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                             </form>
                        </div>
                        <div class="md:col-span-2 bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                             <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><button onclick="fetchUsers()" class="text-primary text-xs font-bold hover:underline"><i class="fa-solid fa-sync"></i> Refresh</button></div>
                             <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="border-b bg-white text-slate-500 uppercase text-xs font-bold"><tr><th class="p-3 pl-6 text-left">User Info</th><th class="p-3 text-left">Role</th><th class="p-3 text-right pr-6">Action</th></tr></thead><tbody id="userListContainerBody" class="divide-y divide-slate-50"></tbody></table></div>
                        </div>
                     </div>
                </div>
                
                <!-- Logs -->
                <div id="view-logs" class="page-view fade-in hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-50 gap-4">
                             <div class="flex items-center gap-2 font-bold text-slate-800"><i class="fa-solid fa-file-shield text-cyan-500"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Server Logs)</div>
                             <div class="flex flex-wrap gap-2 w-full md:w-auto items-center">
                                 <!-- Year Select -->
                                 <select id="logFilterYear" onchange="fetchLogs()" class="bg-white border border-slate-300 text-xs rounded p-1.5 cursor-pointer font-bold">
                                     <!-- Options generated by JS -->
                                 </select>

                                 <!-- Multi-Month Dropdown for Logs -->
                                 <div class="multi-select-container relative">
                                    <button type="button" onclick="toggleMonthSelect(event, 'logMonthDropdown')" class="bg-white border border-slate-300 text-slate-700 text-xs rounded p-1.5 hover:bg-slate-50 flex items-center gap-2 min-w-[140px] justify-between">
                                        <span id="logMonthSelectLabel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</span>
                                        <i class="fa-solid fa-chevron-down text-[10px] text-slate-400"></i>
                                    </button>
                                    <div id="logMonthDropdown" class="multi-select-dropdown w-[200px]">
                                        <div class="flex items-center justify-between p-2 border-b border-slate-100 mb-1">
                                            <span class="text-xs font-bold text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                            <button onclick="selectAllMonths('log')" class="text-xs text-primary hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                        </div>
                                        <div id="logMonthCheckboxes" class="space-y-1 p-1">
                                            <!-- JS Generated -->
                                        </div>
                                    </div>
                                 </div>

                                 <button onclick="fetchLogs()" class="text-sm text-primary hover:underline ml-2"><i class="fa-solid fa-sync"></i> Refresh</button>
                             </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="bg-slate-100 text-slate-700 uppercase font-bold text-xs"><tr><th class="px-6 py-4 whitespace-nowrap">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="px-6 py-4 whitespace-nowrap">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th class="px-6 py-4 whitespace-nowrap">Role</th><th class="px-6 py-4 whitespace-nowrap">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th><th class="px-6 py-4 whitespace-nowrap">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody id="systemLogsContainer" class="divide-y divide-slate-100 font-mono text-xs"><tr><td colspan="5" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody></table></div>
                    </div>
                </div>

                <!-- 7. Map View (Full Tab Mode) -->
                <div id="view-map" class="page-view fade-in hidden h-full">
                    <!-- Map Content injected by JS -->
                </div>

            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl animate-fade-in-up flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl flex-shrink-0">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="fa-solid fa-file-contract text-primary"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
                <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 transition p-2 rounded-full hover:bg-slate-100"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="detailPDFContainer" class="p-8 bg-slate-50/50 overflow-y-auto flex-1">
                <div id="detailContent" class="bg-white shadow-sm border border-slate-200 p-8 rounded-xl max-w-3xl mx-auto"></div>
            </div>
            <div class="p-5 border-t border-slate-100 bg-white rounded-b-2xl flex gap-3 flex-shrink-0">
                <button id="btnDownloadExcel" onclick="downloadExcel()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium transition flex items-center justify-center gap-2 shadow-lg shadow-green-200"><i class="fa-solid fa-file-excel"></i> Download Excel</button>
                <button id="btnPrintReport" onclick="printReport()" class="flex-1 bg-slate-800 text-white py-3 rounded-lg hover:bg-slate-700 font-medium transition flex items-center justify-center gap-2 shadow-lg shadow-slate-300"><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>
    
    <!-- ... Other Modals ... -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl animate-fade-in-up">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <button onclick="document.getElementById('editUserModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="handleEditUserSubmit(event)" class="p-6 space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Username</label><input type="text" id="editUsername" name="user" class="w-full mt-1 p-2.5 bg-slate-100 border border-slate-200 rounded-lg text-slate-500 outline-none cursor-not-allowed" readonly></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Full Name</label><input type="text" id="editName" name="name" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Role</label><select id="editRole" name="role" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition"><option value="user">User</option><option value="admin">Admin</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Permission Area</label><input type="text" id="editPermissionArea" name="permissionArea" placeholder="BKK,UPC or ALL" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">New Password (Optional)</label><input type="password" id="editPass" name="pass" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"></div>
                <div class="pt-2 flex gap-3"><button type="button" onclick="document.getElementById('editUserModal').classList.add('hidden')" class="flex-1 py-2.5 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="flex-1 bg-primary text-white py-2.5 rounded-lg hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
            </form>
        </div>
    </div>

    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl animate-fade-in-up">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                <button onclick="document.getElementById('changePasswordModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="handleChangePasswordSubmit(event)" class="p-6 space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label><input type="password" id="cp_oldPass" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="password" id="cp_newPass" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="password" id="cp_confirmPass" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                <div class="pt-2 flex gap-3"><button type="button" onclick="document.getElementById('changePasswordModal').classList.add('hidden')" class="flex-1 py-2.5 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="flex-1 bg-primary text-white py-2.5 rounded-lg hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
            </form>
        </div>
    </div>
    
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/20 z-[100] flex flex-col items-center justify-center transition-opacity duration-300 backdrop-blur-[2px]">
        <span class="loader"></span>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwV89uY_KDkvJNJ2CUwxNfPX6I4XqQoTMn5L7Novu-6jQDhSBC46DQUBly0j-_O_eWzCw/exec"; 
        const STORAGE = { QUESTIONS: 'app_v2_questions', DRAFT: 'app_v2_draft', USER: 'audit_user_session' };
        let currentUser = null, branchData = {}, zoneList = [], auditRecords = [], currentAuditImages = {}, allBranchDetails = [], globalAllBranches = [], inactivityTimer;
        let questions = [{ id: 'q_default', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server...', allowImage: false }];
        
        let isSingleZoneUser = false; 
        let employeeCount = 0;
        
        // Tom Select Instances
        const tsInstances = {};

        function startInactivityTimer() { resetTimer(); window.addEventListener('mousemove', resetTimer); window.addEventListener('keypress', resetTimer); window.addEventListener('touchmove', resetTimer); }
        function resetTimer() { clearTimeout(inactivityTimer); if (currentUser) { inactivityTimer = setTimeout(() => { localStorage.removeItem(STORAGE.USER); location.reload(); }, 600000); } }

        window.addEventListener('load', () => {
            const storedUser = localStorage.getItem(STORAGE.USER);
            if(storedUser) { currentUser = JSON.parse(storedUser); initSystemAfterLogin(); }
        });

        async function initSystemAfterLogin() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('main-layout').classList.remove('hidden');
            document.getElementById('sidebarName').innerText = currentUser.name;
            document.getElementById('sidebarRole').innerText = currentUser.role;
            document.getElementById('sidebarAvatar').innerText = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('dashWelcomeName').innerText = currentUser.name;
            
            if (currentUser.role.toLowerCase() !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(e => e.classList.add('hidden'));
            } else {
                document.querySelectorAll('.admin-only').forEach(e => e.classList.remove('hidden'));
            }
            
            await fetchBranches(); 
            initFilters(); 
            fetchHistory(false); 
            fetchQuestionsFromAPI(); 
            switchView('view-dashboard'); 
            startInactivityTimer();
        }

        // --- TOM SELECT HELPER ---
        function initTomSelect(selectorId, options = {}) {
            if (tsInstances[selectorId]) {
                tsInstances[selectorId].destroy();
                delete tsInstances[selectorId];
            }
            const el = document.getElementById(selectorId);
            if(el) {
                tsInstances[selectorId] = new TomSelect(el, {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    ...options
                });
            }
        }

        // --- FILTER LOGIC ---
        function toggleMonthSelect(e, dropdownId) {
            e.stopPropagation();
            document.querySelectorAll('.multi-select-dropdown').forEach(el => { if(el.id !== dropdownId) el.classList.remove('show'); });
            document.getElementById(dropdownId).classList.toggle('show');
        }
        function closeMultiSelect(e) {
            if(!e.target.closest('.multi-select-container')) { document.querySelectorAll('.multi-select-dropdown').forEach(el => el.classList.remove('show')); }
        }
        function selectAllMonths(prefix) {
            const boxes = document.querySelectorAll(`.${prefix}-month-checkbox`);
            const allChecked = Array.from(boxes).every(b => b.checked);
            boxes.forEach(b => b.checked = !allChecked);
            if(prefix === 'dash') filterDashboardData(true);
        }

        function initFilters() {
            const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const today = new Date();
            const currentYearAD = today.getFullYear();
            const currentMonthIdx = today.getMonth();
            
            const populateYear = (id) => {
                const el = document.getElementById(id); el.innerHTML = '';
                for(let y = currentYearAD + 1; y >= currentYearAD - 2; y--) {
                    const thaiYear = y + 543; const opt = document.createElement('option'); opt.value = y; opt.innerText = `‡∏õ‡∏µ ${thaiYear}`; if(y === currentYearAD) opt.selected = true; el.appendChild(opt);
                }
            };
            populateYear('dashFilterYear'); populateYear('logFilterYear');

            const populateMultiMonth = (containerId, prefix, defaultSelected) => {
                const container = document.getElementById(containerId); container.innerHTML = '';
                monthNames.forEach((name, idx) => {
                    const val = idx + 1;
                    const div = document.createElement('div'); div.className = 'flex items-center gap-2 p-1 hover:bg-slate-50 rounded cursor-pointer';
                    div.onclick = (e) => { if(e.target.type !== 'checkbox') { const cb = div.querySelector('input'); cb.checked = !cb.checked; if(prefix === 'dash') filterDashboardData(true); } };
                    let isChecked = defaultSelected === 'all' ? true : (idx === currentMonthIdx);
                    div.innerHTML = `<input type="checkbox" value="${val}" class="${prefix}-month-checkbox w-4 h-4 text-primary rounded border-slate-300 focus:ring-primary cursor-pointer" ${isChecked ? 'checked' : ''} onchange="${prefix==='dash'?'filterDashboardData(true)':''}"> <span class="text-sm text-slate-700">${name}</span>`; container.appendChild(div);
                });
                if(prefix === 'dash') updateMonthLabel('dash', 'monthSelectLabel');
                if(prefix === 'log') updateMonthLabel('log', 'logMonthSelectLabel');
            };
            populateMultiMonth('monthCheckboxes', 'dash', 'all'); populateMultiMonth('logMonthCheckboxes', 'log', 'current');

            let optionsHtml = '';
            for (let i = 0; i < 12; i++) {
                let d = new Date(currentYearAD, today.getMonth() - i, 1); let y = d.getFullYear(); let m = d.getMonth(); let val = `${y}-${String(m + 1).padStart(2, '0')}`; let txt = `${monthNames[m]} ${y + 543}`; optionsHtml += `<option value="${val}">${txt}</option>`;
            }
            document.getElementById('histFilterMonth').innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (All Months)</option>` + optionsHtml;
        }
        
        function updateMonthLabel(prefix, labelId) {
            const checked = document.querySelectorAll(`.${prefix}-month-checkbox:checked`);
            const label = document.getElementById(labelId);
            if(checked.length === 0) label.innerText = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; else if(checked.length === 12) label.innerText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'; else label.innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${checked.length} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
        }

        function parseThaiDate(dateStr) {
            if (!dateStr) return null;
            try {
                let parts = dateStr.split(' ')[0].split('/');
                if (parts.length === 3) { let y = parseInt(parts[2]); if (y > 2400) y -= 543; let m = parseInt(parts[1]); return { year: y, month: m, fullDate: dateStr }; }
            } catch(e) {}
            return null;
        }

        function filterDashboardData(animate=false) {
            if(animate) toggleLoading(true);
            updateMonthLabel('dash', 'monthSelectLabel');
            
            setTimeout(() => {
                const selYear = parseInt(document.getElementById('dashFilterYear').value);
                const checkedBoxes = document.querySelectorAll('.dash-month-checkbox:checked');
                const selMonths = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
                const zVal = document.getElementById('dashFilterZone').value;
                
                let filtered = auditRecords.filter(r => {
                    const parsed = parseThaiDate(r.date);
                    if (!parsed) return false;
                    if (parsed.year !== selYear) return false;
                    if (selMonths.length > 0 && !selMonths.includes(parsed.month)) return false;
                    if (zVal !== 'all') {
                        if (isSingleZoneUser) { 
                            // Partial match for Branch name or full match
                            if (!(r.branch || '').toString().includes(zVal)) return false; 
                        } 
                        else { 
                            if (r.zone !== zVal) return false; 
                        }
                    }
                    return true;
                });
                updateDashboardCounts(filtered);
                if(animate) toggleLoading(false);
            }, animate ? 300 : 0);
        }

        function toggleSidebar() { const s = document.getElementById('appSidebar'); const o = document.getElementById('mobileSidebarOverlay'); if (window.innerWidth < 768) { if (s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } } else { if (s.classList.contains('hidden')) { s.classList.remove('hidden'); s.classList.add('flex'); } else { s.classList.add('hidden'); s.classList.remove('flex'); } } }
        function showPopup(t, ti, te) { Swal.fire({ icon: t, title: ti, text: te, confirmButtonColor: '#2563eb' }); }
        function toggleLoading(s) { const o = document.getElementById('loadingOverlay'); if(s) o.classList.remove('hidden'); else o.classList.add('hidden'); }
        function viewImage(url) { if (!url) return; let bigUrl = url; if(url.includes("drive.google.com") && url.includes("id=")) { const m = url.match(/id=([^&]+)/); if(m) bigUrl = `https://drive.google.com/thumbnail?id=${m[1]}&sz=s1000`; } Swal.fire({ imageUrl: bigUrl, imageAlt: 'Image', width: '90%', padding: '1em', background: '#fff', showConfirmButton: false, showCloseButton: true, customClass: { image: 'rounded-lg shadow-lg' } }); }

        async function callAPI(a, p = {}) { try { if (currentUser && !p.requestUser) p.requestUser = currentUser; const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: a, ...p }) }); return await r.json(); } catch (e) { return { success: false, message: e.message }; } }
        async function fetchQuestionsFromAPI(r = false) { if(r) toggleLoading(true); const res = await callAPI('getQuestions', { all: true }); if (res.success) { questions = res.data; localStorage.setItem(STORAGE.QUESTIONS, JSON.stringify(questions)); if(!document.getElementById('view-questions').classList.contains('hidden')) renderQuestionsConfig(); if(!document.getElementById('view-audit').classList.contains('hidden')) initAuditForm(); } if(r) toggleLoading(false); }
        
        async function openAddQuestionModal(id=null,t='',ai=false, isLocked=false) {
            const { value: v } = await Swal.fire({
                title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà',
                html: `<input id="swal-input1" class="swal2-input" value="${t}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°...">
                       <div class="flex flex-col gap-3 mt-4 text-left px-2">
                           <label class="flex items-center gap-2 cursor-pointer border border-slate-200 p-2 rounded-lg hover:bg-slate-50 transition">
                               <input type="checkbox" id="swal-input2" class="w-5 h-5 cursor-pointer accent-primary" ${ai?'checked':''}>
                               <span class="text-sm font-bold text-slate-700">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                           </label>
                           <label class="flex items-center gap-2 cursor-pointer border border-slate-200 p-2 rounded-lg hover:bg-red-50 transition">
                               <input type="checkbox" id="swal-input3" class="w-5 h-5 cursor-pointer accent-red-500" ${isLocked?'checked':''}>
                               <span class="text-sm font-bold text-red-600"><i class="fa-solid fa-lock"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)</span>
                           </label>
                       </div>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => [
                    document.getElementById('swal-input1').value,
                    document.getElementById('swal-input2').checked,
                    document.getElementById('swal-input3').checked
                ]
            });
            if (v) {
                if(!v[0].trim()) return showPopup('warning', '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°');
                toggleLoading(true);
                const r = await callAPI('saveQuestion', { id: id, title: v[0], allowImage: v[1], locked: v[2] });
                toggleLoading(false);
                if(r.success) {
                    fetchQuestionsFromAPI(true);
                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success');
                } else {
                    showPopup('error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', r.message);
                }
            }
        }
        
        async function deleteQuestion(id) { 
            const c = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°?', text: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }); 
            if (c.isConfirmed) { 
                toggleLoading(true); 
                const r = await callAPI('deleteQuestion', { id }); 
                toggleLoading(false); 
                if(r.success) {
                    fetchQuestionsFromAPI(true); 
                } else {
                    showPopup('error', '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', r.message);
                }
            } 
        }
        
        async function handleSaveSettings(e) { e.preventDefault(); toggleLoading(true); const r = await callAPI('saveSettings', { lineToken: document.getElementById('settingLineToken').value, notifyEmail: document.getElementById('settingEmail').value }); toggleLoading(false); if(r.success) showPopup('success', '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', ''); else showPopup('error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', r.message); }

        function switchView(id) {
            toggleLoading(true); 
            setTimeout(() => {
                document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'bg-slate-800', 'text-white'));
                document.getElementById(id).classList.remove('hidden');
                const a = document.querySelector(`a[onclick*="switchView('${id}')"]`); if(a) a.classList.add('active', 'bg-slate-800', 'text-white');
                document.getElementById('pageTitle').innerText = id.replace('view-', '').toUpperCase();
                
                if (id === 'view-audit') { 
                    initAuditForm(); 
                    setTimeout(initSignature, 100); 
                    document.getElementById('headerDate').innerText = new Date().toLocaleDateString('th-TH'); 
                    checkDraft(); 
                }
                if (id === 'view-history') filterHistoryTable();
                if (id === 'view-users') fetchUsers();
                if (id === 'view-logs') fetchLogs(); 
                if (id === 'view-questions') renderQuestionsConfig();
                if (id === 'view-dashboard') filterDashboardData();
                if (id === 'view-settings') { callAPI('getSettings').then(res => { if(res.success) { document.getElementById('settingLineToken').value = res.data.lineToken || ''; document.getElementById('settingEmail').value = res.data.notifyEmail || ''; }}); }
                
                toggleLoading(false);
            }, 300);
        }

        async function handleLogin(e) { e.preventDefault(); toggleLoading(true); const r = await callAPI('login', { user: document.getElementById('loginUser').value, pass: document.getElementById('loginPass').value }); toggleLoading(false); if (r.success) { currentUser = r.user; localStorage.setItem(STORAGE.USER, JSON.stringify(currentUser)); initSystemAfterLogin(); callAPI('logSystem', { user: currentUser.user, role: currentUser.role, logAction: 'LOGIN', details: 'Success' }); } else showPopup('error', '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', r.message); }
        function logout() { Swal.fire({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((r) => { if (r.isConfirmed) { localStorage.removeItem(STORAGE.USER); location.reload(); } }); }

        async function fetchBranches() {
            const res = await callAPI('getBranches');
            if (res.success) {
                globalAllBranches = res.data; let rawBranches = res.data;
                
                // Allow seeing history from other users in SAME Zone
                if (currentUser.role.toLowerCase() !== 'admin' && currentUser.permissionArea && currentUser.permissionArea !== 'ALL') {
                    const allowed = currentUser.permissionArea.split(',').map(z => z.trim());
                    rawBranches = rawBranches.filter(b => allowed.includes(b.region) || allowed.includes(b.zone) || allowed.includes(b.id));
                } else if (currentUser.role.toLowerCase() === 'admin' && currentUser.permissionArea && currentUser.permissionArea !== 'ALL') {
                    const allowed = currentUser.permissionArea.split(',').map(z => z.trim());
                    rawBranches = rawBranches.filter(b => allowed.includes(b.region) || allowed.includes(b.zone) || allowed.includes(b.id));
                }
                
                branchData = {}; zoneList = []; allBranchDetails = [];
                rawBranches.forEach(item => { const z = item.zone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; if (!branchData[z]) { branchData[z] = []; zoneList.push(z); } branchData[z].push({ id: item.id, name: item.name }); allBranchDetails.push(item); });
                
                isSingleZoneUser = (zoneList.length === 1);
                
                const dSel = document.getElementById('dashFilterZone'); dSel.innerHTML = '';
                if (isSingleZoneUser) {
                    const z = zoneList[0];
                    dSel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (All Branches)</option>';
                    if(branchData[z]) branchData[z].forEach(b => dSel.innerHTML += `<option value="${b.name}">[${b.id}] ${b.name}</option>`);
                } else {
                    dSel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï (All Zones)</option>';
                    zoneList.forEach(z => dSel.innerHTML += `<option value="${z}">${z}</option>`);
                }
                initTomSelect('dashFilterZone'); // Init
                
                const hSel = document.getElementById('histFilterZone'); 
                hSel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</option>';
                zoneList.forEach(z => hSel.innerHTML += `<option value="${z}">${z}</option>`);
                initTomSelect('histFilterZone'); // Init
                
                initTomSelect('histFilterBranch'); 
                
                if(auditRecords.length > 0) filterDashboardData();
            }
        }

        function updateDashboardCounts(d) {
             const data = d || auditRecords; 
             const audited = data.length;
             const fail = data.filter(r => r.result === '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô').length;
             
             let targetBranches = [];
             const fVal = document.getElementById('dashFilterZone').value;
             
             if (isSingleZoneUser) {
                 const z = zoneList[0];
                 const zBranches = allBranchDetails.filter(b => b.zone === z);
                 if (fVal !== 'all') targetBranches = zBranches.filter(b => b.name === fVal); else targetBranches = zBranches;
             } else {
                 if (fVal !== 'all') targetBranches = allBranchDetails.filter(b => b.zone === fVal); else targetBranches = allBranchDetails;
             }
             
             const total = targetBranches.length;
             const uSet = new Set();
             data.forEach(r => { let b = r.branch; if(b.includes('] ')) b = b.split('] ')[1]; uSet.add(b.trim()); });
             const remaining = Math.max(0, total - uSet.size);

             document.getElementById('dashTotalBranches').innerText = total; document.getElementById('dashAudited').innerText = audited; 
             document.getElementById('dashRemaining').innerText = remaining; document.getElementById('dashFailCount').innerText = fail;
             renderZoneStats(data);
        }

        function renderZoneStats(filteredData) {
            const con = document.getElementById('zoneStatList'); if(!con) return;
            const zFilter = document.getElementById('dashFilterZone').value;
            let dZones = zoneList;
            if (!isSingleZoneUser && zFilter !== 'all') dZones = [zFilter];

            con.innerHTML = dZones.map(z => {
                if(!branchData[z]) return ''; 
                let bScope = branchData[z];
                if (isSingleZoneUser && zFilter !== 'all') bScope = bScope.filter(b => b.name === zFilter);
                
                const total = bScope.length;
                const aSet = new Set();
                filteredData.filter(r => r.zone === z).forEach(r => { let b = r.branch; if(b.includes('] ')) b = b.split('] ')[1]; aSet.add(b.trim()); });
                const audited = aSet.size;
                const rem = Math.max(0, total - audited);
                const p = total > 0 ? (audited / total) * 100 : 0;
                
                return `<div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-default group overflow-hidden relative flex flex-col"><div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-blue-400 to-indigo-500"></div><div class="pl-2 mb-4 flex justify-between items-start"><div><div class="text-[10px] text-slate-400 mb-0.5 group-hover:text-primary transition font-bold uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï (Zone)</div><div class="font-bold text-slate-700 text-xl group-hover:scale-105 transition origin-left">${z}</div></div><div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-lg shadow-sm border border-blue-100"><i class="fa-solid fa-map-location-dot"></i></div></div><div class="pl-2 grid grid-cols-3 gap-2 text-center mt-auto"><div class="bg-slate-50 rounded-lg p-2 border border-slate-100 shadow-sm hover:bg-slate-100 transition"><div class="text-[9px] sm:text-[10px] text-slate-500 font-bold mb-1">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="font-bold text-slate-800 text-lg sm:text-xl">${total}</div></div><div class="bg-green-50 rounded-lg p-2 border border-green-100 shadow-sm hover:bg-green-100 transition"><div class="text-[9px] sm:text-[10px] text-green-600 font-bold mb-1">‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</div><div class="font-bold text-green-700 text-lg sm:text-xl">${audited}</div></div><div class="bg-orange-50 rounded-lg p-2 border border-orange-100 shadow-sm hover:bg-orange-100 transition"><div class="text-[9px] sm:text-[10px] text-orange-600 font-bold mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="font-bold text-orange-700 text-lg sm:text-xl">${rem}</div></div></div><div class="pl-2 mt-5"><div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1.5"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span><span class="${p === 100 ? 'text-green-500' : ''}">${p.toFixed(0)}%</span></div><div class="w-full bg-slate-100 rounded-full h-2 shadow-inner overflow-hidden"><div class="bg-gradient-to-r from-emerald-400 to-green-500 h-2 rounded-full transition-all duration-1000" style="width: ${p}%"></div></div></div></div>`;
            }).join('');
        }

        function calculateDebt() { const ar = parseFloat(document.getElementById('f_ar').value.replace(/,/g, '')) || 0; const netAr = parseFloat(document.getElementById('f_net_ar').value.replace(/,/g, '')) || 0; document.getElementById('f_npl_baht').value = (ar - netAr).toLocaleString('en-US', {minimumFractionDigits: 2}); saveDraft(); }
        function formatInputCurrency(el) { let val = parseFloat(el.value.replace(/,/g, '')); if(!isNaN(val)) el.value = val.toLocaleString('en-US', {minimumFractionDigits: 2}); }
        function calculatePerformance() { const target = parseFloat(document.getElementById('f_target').value) || 0; const actual = parseFloat(document.getElementById('f_actual').value) || 0; document.getElementById('f_percent').value = target > 0 ? (actual / target * 100).toFixed(2) + '%' : '-'; saveDraft(); }
        function compressImage(file, maxWidth = 1000) { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; }; }); }
        async function handleImageSelect(input, qId) { if (input.files && input.files[0]) { try { document.getElementById(`file_status_${qId}`).innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; const compressed = await compressImage(input.files[0]); currentAuditImages[qId] = compressed; document.getElementById(`file_status_${qId}`).innerHTML = `<i class="fa-solid fa-circle-check text-green-500 text-lg"></i>`; saveDraft(); } catch (e) { console.error(e); } } }
        function collectFormData() { const d = {}; document.querySelectorAll('#auditForm input:not([type="radio"]), #auditForm select, #auditForm textarea').forEach(el => { if(el.id) d[el.id] = el.value; }); document.querySelectorAll('input[type="radio"]:checked').forEach(r => d[r.name] = r.value); return d; }
        function saveDraft() { localStorage.setItem(STORAGE.DRAFT, JSON.stringify(collectFormData())); }
        function checkDraft() { if(localStorage.getItem(STORAGE.DRAFT)) document.getElementById('draftNotice').classList.remove('hidden'); }
        function restoreDraft(data) { 
            if(!data) return;
            document.getElementById('zoneSelect').value = data['zoneSelect']; handleZoneChange(); 
            
            let maxEmpIdx = -1;
            for(const k in data) { if(k.startsWith('emp_id_')) { const idx = parseInt(k.replace('emp_id_', '')); if(idx > maxEmpIdx) maxEmpIdx = idx; } }
            document.getElementById('employeesContainer').innerHTML = ''; employeeCount = 0;
            for(let i=0; i<=maxEmpIdx; i++) { if(data[`emp_id_${i}`] !== undefined) { document.getElementById('employeesContainer').insertAdjacentHTML('beforeend', getEmployeeTemplate(i)); employeeCount = i+1; } }
            if(employeeCount === 0) { document.getElementById('employeesContainer').innerHTML = getEmployeeTemplate(0); employeeCount = 1; }

            setTimeout(() => { for (const k in data) { const el = document.getElementById(k); if (el) el.value = data[k]; else { const r = document.querySelector(`input[name="${k}"][value="${data[k]}"]`); if(r) r.checked = true; } } document.getElementById('draftNotice').classList.add('hidden'); }, 200); 
        }
        function clearDraft() { localStorage.removeItem(STORAGE.DRAFT); document.getElementById('draftNotice').classList.add('hidden'); document.getElementById('auditForm').reset(); }
        function handleZoneChange() { 
            const z = document.getElementById('zoneSelect').value; 
            const bSel = document.getElementById('branchSelect'); 
            
            // Destroy previous TomSelect on branchSelect before changing options
            if(tsInstances['branchSelect']) {
                tsInstances['branchSelect'].destroy();
                delete tsInstances['branchSelect'];
            }
            
            bSel.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>'; 
            
            if (z && branchData[z]) { 
                bSel.disabled = false; 
                branchData[z].forEach(b => { 
                    const d = b.id && b.id !== '-' ? `[${b.id}] ${b.name}` : b.name; 
                    bSel.innerHTML += `<option value="${d}">${d}</option>`; 
                }); 
                initTomSelect('branchSelect'); // Re-init TomSelect
            } else { 
                bSel.disabled = true; 
            } 
            saveDraft(); 
        }
        function getLocation() { const g = document.getElementById('gpsCoords'); g.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."; navigator.geolocation.getCurrentPosition(p => { g.value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`; saveDraft(); }, e => { g.value = ""; showPopup('error', 'GPS Error', e.message); }); }
        async function submitAudit(e) { 
            e.preventDefault(); 
            if(!document.getElementById('gpsCoords').value) { showPopup('warning', '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS'); return; } 
            const sigCanvas = document.getElementById('signaturePad'); 
            if(sigCanvas.toDataURL() === document.createElement('canvas').toDataURL()) { showPopup('warning', '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô'); return; } 
            
            const raw = collectFormData(); 
            const details = []; 
            
            const mapBranch = { 'f_site':'‡πÑ‡∏ã‡∏ï‡πå', 'f_target':'‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', 'f_actual':'‡∏¢‡∏≠‡∏î‡∏ó‡∏≥‡πÑ‡∏î‡πâ', 'f_percent':'% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤', 'f_od1':'OD1 %', 'f_od2':'OD2 %', 'f_od3':'OD3 %', 'f_npl_percent':'NPL %', 'f_ar':'AR', 'f_net_ar':'NET AR', 'f_npl_baht':'NPL (‡∏ö‡∏≤‡∏ó)' };
            for(const k in mapBranch) { if(raw[k] !== undefined && raw[k] !== '') details.push({q: mapBranch[k], res: raw[k], note: ''}); }
            
            for(let i=0; i<=10; i++) {
                if(raw[`emp_id_${i}`] || raw[`emp_firstname_${i}`]) {
                    const eMap = { 'emp_id':'‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'emp_firstname':'‡∏ä‡∏∑‡πà‡∏≠', 'emp_lastname':'‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'rate_person':'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', 'rate_sale':'‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'rate_k_m':'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤M', 'rate_k_ctv':'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤CTV', 'rate_k_hl':'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤HL', 'rate_k_promo':'‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', 'emp_note':'‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' };
                    for(const k in eMap) { if(raw[`${k}_${i}`] !== undefined) details.push({q: `${k}_${i}`, res: raw[`${k}_${i}`], note: ''}); }
                }
            }
            
            const map5S = { 'rate_c_branch':'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤', 'rate_c_desk':'‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'rate_c_coffee':'‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°', 'rate_c_toilet':'‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', 'rate_c_storage':'‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á', 'rate_c_back':'‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤' };
            for(const k in map5S) { if(raw[k] !== undefined) details.push({q: map5S[k], res: raw[k], note: ''}); }
            if(raw['area_comment']) details.push({q: 'area_comment', res: raw['area_comment'], note: ''});
            
            let totalQ = 0; let passQ = 0;
            questions.forEach(q => { 
                if(raw[q.id]) {
                    details.push({ q: q.title, res: raw[q.id], note: raw[`note_${q.id}`], image: currentAuditImages[q.id] || "" }); 
                    totalQ++; 
                    if(raw[q.id] === '‡∏ú‡πà‡∏≤‡∏ô') passQ++;
                }
            }); 
            
            let finalRes = '‡∏ú‡πà‡∏≤‡∏ô';
            if(totalQ > 0) { 
                // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 50% ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏ú‡πà‡∏≤‡∏ô
                finalRes = (passQ / totalQ > 0.5) ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'; 
            } else { 
                finalRes = details.some(d=>d.res==='‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')?'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô':'‡∏ú‡πà‡∏≤‡∏ô'; 
            }
            
            const rec = { id: Date.now().toString(), date: new Date().toLocaleString('th-TH'), auditor: currentUser.name, zone: document.getElementById('zoneSelect').value, branch: document.getElementById('branchSelect').value, gps: document.getElementById('gpsCoords').value, result: finalRes, summary: document.getElementById('summaryComment').value, signature: sigCanvas.toDataURL(), details: details }; 
            
            toggleLoading(true); 
            const res = await callAPI('submitAudit', { record: rec }); 
            toggleLoading(false); 
            
            if (res.success) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); clearDraft(); document.getElementById('branchSelect').disabled = true; currentAuditImages = {}; switchView('view-history'); } 
            else { showPopup('error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'); } 
        }
        function initSignature() { const c = document.getElementById('signaturePad'); setTimeout(() => { if(!c.parentElement) return; c.width = c.parentElement.clientWidth; c.height = c.parentElement.clientHeight; const ctx = c.getContext('2d'); ctx.lineWidth=2; let drawing=false; const getPos = (e) => { const r=c.getBoundingClientRect(); return { x: (e.clientX||e.touches[0].clientX)-r.left, y: (e.clientY||e.touches[0].clientY)-r.top }; }; const start = (e) => { drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); e.preventDefault(); }; const move = (e) => { if(!drawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); e.preventDefault(); }; const end = () => drawing=false; c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); c.addEventListener('mouseup', end); c.addEventListener('touchstart', start); c.addEventListener('touchmove', move); c.addEventListener('touchend', end); }, 500); }
        function clearSignature() { const c=document.getElementById('signaturePad'); c.getContext('2d').clearRect(0,0,c.width,c.height); }
        
        // --- NEW/UPDATED RENDER QUESTIONS CONFIG ---
        function renderQuestionsConfig() {
            const list = document.getElementById('questionsListConfig');
            if(!questions || questions.length === 0) { 
                list.innerHTML = `<div class="text-center py-6 text-slate-500 bg-slate-50 rounded-xl border border-slate-200 shadow-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</div>`; 
                return; 
            }
            const protectedIds = ['q1', 'q2', 'q3', 'q4']; // Default protected items if backend doesn't provide
            const isAdmin = currentUser && currentUser.role.toLowerCase() === 'admin';

            list.innerHTML = questions.map(q => {
                const safeTitle = q.title ? q.title.replace(/'/g, "\\'").replace(/"/g, "&quot;") : "";
                
                // Determine lock status. Explicit locked property takes precedence.
                const isLocked = q.locked !== undefined ? q.locked : protectedIds.includes(q.id);
                
                // Rules: 
                // Admin can edit all. Admin can only delete UNLOCKED.
                // Standard users cannot edit or delete locked.
                const canEdit = isAdmin || !isLocked;
                const canDelete = (isAdmin && !isLocked) || (!isAdmin && !isLocked);

                return `
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-white border border-slate-200 rounded-lg hover:shadow-md transition group gap-4 relative overflow-hidden">
                    ${isLocked ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-red-400"></div>' : '<div class="absolute left-0 top-0 bottom-0 w-1 bg-slate-200"></div>'}
                    
                    <div class="flex-1 pl-2">
                        <div class="font-bold text-slate-700 text-base sm:text-lg">${q.title}</div>
                        <div class="text-xs text-slate-400 font-mono mt-1 flex flex-wrap items-center gap-2">
                            <span class="bg-slate-100 px-2 py-0.5 rounded border border-slate-200">ID: ${q.id}</span>
                            ${q.allowImage?'<span class="text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-200 font-bold"><i class="fa-solid fa-camera"></i> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>':''}
                            ${isLocked?'<span class="text-red-500 bg-red-50 px-2 py-0.5 rounded border border-red-200 font-bold"><i class="fa-solid fa-lock"></i> ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)</span>':''}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mt-2 sm:mt-0 pt-2 sm:pt-0 border-t sm:border-0 border-slate-100">
                        ${isAdmin ? `
                        <label class="flex items-center cursor-pointer mr-1 sm:mr-3 px-2 py-1.5 rounded-lg hover:bg-slate-50 transition" title="‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å/‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°">
                            <input type="checkbox" class="sr-only peer" ${isLocked ? 'checked' : ''} onchange="toggleQuestionLock('${q.id}', this.checked, '${safeTitle}', ${q.allowImage})">
                            <div class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500 shadow-inner"></div>
                            <span class="ml-2 text-xs font-bold ${isLocked ? 'text-red-600' : 'text-slate-500'} select-none hidden sm:inline-block">${isLocked ? '‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà' : '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å'}</span>
                        </label>
                        ` : ''}

                        ${canEdit ? `<button onclick="openAddQuestionModal('${q.id}', '${safeTitle}', ${q.allowImage}, ${isLocked})" class="w-9 h-9 sm:w-10 sm:h-10 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition flex items-center justify-center shadow-sm border border-blue-100" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"><i class="fa-solid fa-pen"></i></button>` : ''}
                        
                        ${canDelete ? `<button onclick="deleteQuestion('${q.id}')" class="w-9 h-9 sm:w-10 sm:h-10 rounded-lg bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center shadow-sm border border-red-100" title="‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"><i class="fa-solid fa-trash"></i></button>` : `<button class="w-9 h-9 sm:w-10 sm:h-10 rounded-lg bg-slate-50 text-slate-300 cursor-not-allowed flex items-center justify-center border border-slate-100" title="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ"><i class="fa-solid fa-lock"></i></button>`}
                    </div>
                </div>`;
            }).join('');
        }

        // --- NEW FUNCTION: TOGGLE LOCK STATUS ---
        window.toggleQuestionLock = async function(id, isLocked, title, allowImage) {
            toggleLoading(true);
            const r = await callAPI('saveQuestion', { id: id, title: title, allowImage: allowImage, locked: isLocked });
            toggleLoading(false);
            
            if(r.success) {
                // Update Local Data
                const qIndex = questions.findIndex(x => x.id === id);
                if(qIndex > -1) {
                    questions[qIndex].locked = isLocked;
                    localStorage.setItem(STORAGE.QUESTIONS, JSON.stringify(questions));
                }
                renderQuestionsConfig(); // Refresh UI
                
                // Show tiny success message
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: isLocked ? '‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
                    showConfirmButton: false,
                    timer: 1500
                });
            } else {
                showPopup('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', r.message);
                renderQuestionsConfig(); // Revert toggle visually on error
            }
        }
        
        function getEmployeeTemplate(i) {
            return `
            <div class="employee-block bg-white border border-purple-100 shadow-sm rounded-xl p-5 mb-5 relative transition-all" id="emp_block_${i}">
                ${i > 0 ? `<button type="button" onclick="removeEmployee(${i})" class="absolute top-4 right-4 text-red-500 hover:text-red-700 font-bold text-xs bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg transition"><i class="fa-solid fa-trash"></i> ‡∏•‡∏ö</button>` : ''}
                <h4 class="font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2 flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs">${i+1}</div>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${i+1}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="input-group"><label class="input-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" id="emp_id_${i}" class="input-box text-center font-mono" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required oninput="saveDraft()"></div>
                    <div class="input-group"><label class="input-label">‡∏ä‡∏∑‡πà‡∏≠ (First Name)</label><input type="text" id="emp_firstname_${i}" class="input-box" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required oninput="saveDraft()"></div>
                    <div class="input-group"><label class="input-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)</label><input type="text" id="emp_lastname_${i}" class="input-box" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required oninput="saveDraft()"></div>
                </div>
                
                <div class="rating-table-container mb-4">
                    <table class="rating-table">
                        <thead><tr><th class="text-left pl-4">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏ó‡∏±‡∏Å‡∏©‡∏∞)</th><th width="60">1</th><th width="60">2</th><th width="60">3</th><th width="60">4</th><th width="60">5</th></tr></thead>
                        <tbody>
                            <tr><td class="rating-topic pl-4">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û/‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢</td>${[1,2,3,4,5].map(v => `<td class="radio-cell"><input type="radio" name="rate_person_${i}" value="${v}" class="custom-radio" onchange="saveDraft()"></td>`).join('')}</tr>
                            <tr><td class="rating-topic pl-4">‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</td>${[1,2,3,4,5].map(v => `<td class="radio-cell"><input type="radio" name="rate_sale_${i}" value="${v}" class="custom-radio" onchange="saveDraft()"></td>`).join('')}</tr>
                        </tbody>
                    </table>
                </div>
                <label class="input-label mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
                <div class="rating-table-container mb-4">
                    <table class="rating-table">
                        <thead><tr><th class="text-left pl-4">‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</th><th width="60">1</th><th width="60">2</th><th width="60">3</th><th width="60">4</th><th width="60">5</th></tr></thead>
                        <tbody>
                            <tr><td class="rating-topic pl-4">‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ M</td>${[1,2,3,4,5].map(v => `<td class="radio-cell"><input type="radio" name="rate_k_m_${i}" value="${v}" class="custom-radio" onchange="saveDraft()"></td>`).join('')}</tr>
                            <tr><td class="rating-topic pl-4">‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ CTV</td>${[1,2,3,4,5].map(v => `<td class="radio-cell"><input type="radio" name="rate_k_ctv_${i}" value="${v}" class="custom-radio" onchange="saveDraft()"></td>`).join('')}</tr>
                            <tr><td class="rating-topic pl-4">‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ HL</td>${[1,2,3,4,5].map(v => `<td class="radio-cell"><input type="radio" name="rate_k_hl_${i}" value="${v}" class="custom-radio" onchange="saveDraft()"></td>`).join('')}</tr>
                            <tr><td class="rating-topic pl-4">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</td>${[1,2,3,4,5].map(v => `<td class="radio-cell"><input type="radio" name="rate_k_promo_${i}" value="${v}" class="custom-radio" onchange="saveDraft()"></td>`).join('')}</tr>
                        </tbody>
                    </table>
                </div>
                <div class="input-group mb-0">
                    <label class="input-label text-purple-600"><i class="fa-regular fa-comment-dots"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</label>
                    <input type="text" id="emp_note_${i}" class="input-box bg-purple-50/50 border-purple-200 focus:border-purple-500" placeholder="‡∏Ñ‡∏≥‡∏ä‡∏°‡πÄ‡∏ä‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á..." oninput="saveDraft()">
                </div>
            </div>
            `;
        }

        function addEmployee() {
            if(employeeCount >= 5) { showPopup('warning','‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö'); return; }
            const container = document.getElementById('employeesContainer');
            container.insertAdjacentHTML('beforeend', getEmployeeTemplate(employeeCount));
            employeeCount++;
            saveDraft();
        }

        function removeEmployee(idx) {
            const block = document.getElementById(`emp_block_${idx}`);
            if(block) { block.remove(); saveDraft(); }
        }

        function initAuditForm() {
            const zSel = document.getElementById('zoneSelect'); 
            
            // Destroy TomSelect if exists
            if(tsInstances['zoneSelect']) {
                tsInstances['zoneSelect'].destroy();
                delete tsInstances['zoneSelect'];
            }
            
            zSel.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>';
            zoneList.forEach(z => { 
                zSel.innerHTML += `<option value="${z}">${z}</option>`; 
            });
            
            initTomSelect('zoneSelect'); // Init TomSelect on Form Zone

            if(isSingleZoneUser && zoneList.length > 0) {
                // If using TomSelect, set value via API
                if(tsInstances['zoneSelect']) {
                    tsInstances['zoneSelect'].setValue(zoneList[0]);
                } else {
                    zSel.value = zoneList[0];
                }
                handleZoneChange(); 
            }

            currentAuditImages = {}; 
            
            document.getElementById('employeesContainer').innerHTML = getEmployeeTemplate(0);
            employeeCount = 1;
            
            if(questions.length > 0) {
                const activeQs = questions.filter(q => q.active !== false);
                document.getElementById('questionsContainer').innerHTML = activeQs.map((q, i) => `
                    <div class="check-item group">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-start gap-3">
                                <span class="bg-slate-100 text-slate-500 text-xs font-bold px-2 py-1 rounded mt-0.5 border border-slate-200 shadow-sm">‡∏Ç‡πâ‡∏≠ ${i+1}</span>
                                <div class="font-bold text-slate-700 leading-tight pt-0.5">${q.title}</div>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center pl-0 md:pl-10 mt-2">
                            <div class="segmented-control">
                                <label>
                                    <input type="radio" name="${q.id}" value="‡∏ú‡πà‡∏≤‡∏ô" class="segment-radio" onchange="saveDraft()">
                                    <div class="segment-label"><i class="fa-solid fa-check"></i> ‡∏ú‡πà‡∏≤‡∏ô</div>
                                </label>
                                <label>
                                    <input type="radio" name="${q.id}" value="‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" class="segment-radio" onchange="saveDraft()">
                                    <div class="segment-label"><i class="fa-solid fa-xmark"></i> ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
                                </label>
                            </div>
                            <input type="text" id="note_${q.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." class="input-box flex-1 bg-white" oninput="saveDraft()">
                            ${q.allowImage ? `<label for="file_${q.id}" class="cursor-pointer flex items-center justify-center gap-2 bg-white border border-slate-300 text-slate-500 hover:text-blue-600 hover:border-blue-600 px-4 py-2 rounded-lg transition shadow-sm w-full md:w-auto h-[42px]"><i class="fa-solid fa-camera"></i> <span class="text-sm font-bold">‡∏£‡∏π‡∏õ</span> <span id="file_status_${q.id}" class="text-xs"></span></label><input type="file" id="file_${q.id}" accept="image/*" class="hidden" onchange="handleImageSelect(this, '${q.id}')">` : ''}
                        </div>
                    </div>`).join('');
            }
        }

        async function fetchHistory(render=true) { 
            if(render) toggleLoading(true); const res = await callAPI('getHistory'); if(render) toggleLoading(false); if(res.success) { let rawRecords = res.data;
                // Security Check on History: Ensure user sees all permitted zone data, regardless of Auditor
                if (currentUser.role.toLowerCase() !== 'admin' && currentUser.permissionArea && currentUser.permissionArea !== 'ALL') {
                    const allowed = currentUser.permissionArea.split(',').map(s => s.trim());
                    // Filter matches if Zone OR Branch OR any part of them matches allowed list
                    // Basically, if the record belongs to the Zone the user manages, show it.
                    rawRecords = rawRecords.filter(r => allowed.some(z => (r.zone || '').toString().includes(z) || (r.branch || '').toString().includes(z)));
                } else if (currentUser.role.toLowerCase() === 'admin' && currentUser.permissionArea && currentUser.permissionArea !== 'ALL') {
                    // Similar logic for Admin with restricted scope
                    // Note: zoneList is already populated with allowed zones
                    rawRecords = rawRecords.filter(r => zoneList.includes(r.zone));
                }
                auditRecords = rawRecords; filterDashboardData(); if(render) filterHistoryTable();
            } 
        }
        
        function handleHistZoneChange(animate=false) { 
            if(animate) toggleLoading(true);
            setTimeout(() => {
                const z = document.getElementById('histFilterZone').value; 
                const bSel = document.getElementById('histFilterBranch'); 
                
                // Re-init TomSelect for Branch
                if(tsInstances['histFilterBranch']) {
                    tsInstances['histFilterBranch'].destroy();
                    delete tsInstances['histFilterBranch'];
                }
                
                bSel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>'; 
                if(z !== 'all' && branchData[z]) { 
                    branchData[z].forEach(b => { bSel.innerHTML += `<option value="${b.name}">[${b.id}] ${b.name}</option>`; }); 
                } 
                
                initTomSelect('histFilterBranch');
                filterHistoryTable(); 
                if(animate) toggleLoading(false);
            }, animate ? 300 : 0);
        }
        function filterHistoryTable(animate=false) { 
            if(animate) toggleLoading(true);
            setTimeout(() => {
                const m = document.getElementById('histFilterMonth').value; const z = document.getElementById('histFilterZone').value; const b = document.getElementById('histFilterBranch').value; 
                const filtered = auditRecords.filter(r => { let matchTime = true; if (m !== 'all') { const parsed = parseThaiDate(r.date); if (parsed && parsed.year + '-' + String(parsed.month).padStart(2,'0') !== m) matchTime = false; } let matchZone = (z === 'all') || (r.zone === z); let matchBranch = (b === 'all') || ((r.branch || '').toString().includes(b)); return matchTime && matchZone && matchBranch; }); 
                renderHistoryTable(filtered); 
                if(animate) toggleLoading(false);
            }, animate ? 300 : 0);
        }
        function renderHistoryTable(records) { document.getElementById('auditLogContainer').innerHTML = records.map(r => ` <tr class="border-b hover:bg-slate-50"><td class="p-3">${r.date}</td><td class="p-3 font-bold">${r.branch}</td><td class="p-3">${r.auditor}</td> <td class="p-3"><span class="px-2 py-1 rounded-md text-xs border ${r.result==='‡∏ú‡πà‡∏≤‡∏ô'?'bg-green-50 text-green-700':'bg-red-50 text-red-700'} font-bold">${r.result}</span></td> <td class="p-3 text-center flex items-center justify-center gap-2"> <button onclick='openDetail("${r.id}")' class="text-primary text-xs border border-primary px-3 py-1 rounded hover:bg-primary hover:text-white transition">View</button> <button onclick='openMap("${r.id}")' class="text-cyan-500 text-xs border border-cyan-500 px-3 py-1 rounded hover:bg-cyan-500 hover:text-white transition"><i class="fa-solid fa-map-location-dot"></i> Map</button> ${currentUser && currentUser.role === 'admin' ? `<button onclick="deleteAudit('${r.id}')" class="text-red-500 text-xs border border-red-500 px-2 py-1 rounded hover:bg-red-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>` : ''} </td></tr>`).join(''); }
        
        function openMap(id) { const rec = auditRecords.find(r => r.id == id); if (!rec) return; let lat = '13.7563', lon = '100.5018'; if(rec.gps && rec.gps.includes(',')) { [lat, lon] = rec.gps.split(',').map(s => s.trim()); } let branchCode = "-"; let branchName = rec.branch; if ((rec.branch || '').toString().includes(']')) { const parts = rec.branch.split(']'); branchName = parts[1].trim(); branchCode = parts[0].replace('[','').trim(); } const mapUrl = `https://maps.google.com/maps?q=${lat},${lon}&z=15&output=embed`; const navigateUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`; const htmlContent = ` <div class="relative w-full h-[85vh] bg-slate-200 rounded-xl overflow-hidden font-sans text-left shadow-sm border border-slate-200 group"> <button onclick="switchView('view-history')" class="absolute top-4 left-4 z-10 bg-white text-slate-700 hover:text-primary px-4 py-2 rounded-lg shadow-md font-bold transition flex items-center border border-slate-200"> <i class="fa-solid fa-arrow-left mr-2"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö </button> <iframe width="100%" height="100%" src="${mapUrl}" frameborder="0" style="border:0; filter: grayscale(10%);" allowfullscreen></iframe> <div class="absolute inset-0 flex items-center justify-center pointer-events-none p-4"> <div class="pointer-events-auto bg-white/95 backdrop-blur-md p-6 rounded-2xl shadow-2xl border border-white/50 w-full max-w-sm transform transition-all duration-300 hover:scale-105"> <div class="flex justify-between items-start mb-4"> <div class="flex items-center gap-4"> <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white text-2xl shadow-lg ring-4 ring-white"> <i class="fa-solid fa-store"></i> </div> <div> <h4 class="font-bold text-slate-800 text-lg leading-tight">${branchName}</h4> <div class="text-xs text-slate-500 font-bold mt-1 bg-slate-100 px-2 py-0.5 rounded-full inline-block">CODE: ${branchCode}</div> </div> </div> <button onclick="switchView('view-history')" class="text-slate-400 hover:text-slate-600 transition bg-slate-50 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button> </div> <div class="space-y-3 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100"> <div class="flex items-center gap-3 text-sm"> <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 shadow-sm"><i class="fa-solid fa-map-pin"></i></div> <div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</div><div class="font-mono text-xs text-slate-700 font-bold">${lat}, ${lon}</div></div> </div> <div class="flex items-center gap-3 text-sm"> <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm"><i class="fa-regular fa-calendar-check"></i></div> <div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à</div><div class="font-bold text-slate-700">${rec.date}</div></div> </div> <div class="flex items-center gap-3 text-sm"> <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-yellow-500 shadow-sm"><i class="fa-solid fa-star"></i></div> <div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div><div class="${rec.result === '‡∏ú‡πà‡∏≤‡∏ô' ? 'text-green-600' : 'text-red-600'} font-bold">${rec.result}</div></div> </div> </div> <div class="grid grid-cols-2 gap-3"> <button onclick="openAuditGallery('${rec.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-indigo-200"><i class="fa-solid fa-images"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button> <a href="${navigateUrl}" target="_blank" class="bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-emerald-200"><i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a> </div> </div> </div> </div>`; document.getElementById('view-map').innerHTML = htmlContent; switchView('view-map'); }
        let galleryImages = [], galleryIndex = 0; function changeGalleryImage(step) { if (galleryImages.length === 0) return; galleryIndex = (galleryIndex + step + galleryImages.length) % galleryImages.length; const img = document.getElementById('galleryImg'); if(img) img.src = galleryImages[galleryIndex].url; const title = document.getElementById('galleryTitle'); if(title) title.innerText = galleryImages[galleryIndex].title; const count = document.getElementById('galleryCount'); if(count) count.innerText = `${galleryIndex + 1} / ${galleryImages.length}`; }
        function openAuditGallery(id) { const rec = auditRecords.find(r => r.id == id); if (!rec) return; galleryImages = []; if(rec.details) rec.details.forEach(d => { if(d.image) galleryImages.push({ title: d.q, url: fixDriveUrl(d.image) }); }); if(galleryImages.length === 0) { Swal.fire({ icon: 'info', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û' }); return; } galleryIndex = 0; Swal.fire({ html: ` <div class="relative bg-black h-[80vh] flex flex-col rounded-lg"> <div class="absolute top-0 left-0 right-0 p-4 flex justify-between z-10 bg-gradient-to-b from-black/80 to-transparent"> <div class="text-left"><h3 id="galleryTitle" class="text-white font-bold">${galleryImages[0].title}</h3><div id="galleryCount" class="text-white/80 text-xs">1 / ${galleryImages.length}</div></div> <button onclick="Swal.close()" class="text-white text-xl"><i class="fa-solid fa-xmark"></i></button> </div> <div class="flex-1 flex items-center justify-center bg-zinc-900 relative"> <img id="galleryImg" src="${galleryImages[0].url}" class="max-w-full max-h-full object-contain"> <button onclick="changeGalleryImage(-1)" class="absolute left-4 w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button> <button onclick="changeGalleryImage(1)" class="absolute right-4 w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button> </div> </div>`, width: '90%', padding: 0, showConfirmButton: false, background: 'transparent' }); }
        function fixDriveUrl(url) { if (url && url.includes("drive.google.com") && url.includes("id=")) { const match = url.match(/id=([^&]+)/); if (match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=s1000`; } return url; }
        function getVal(arr, key) { const f = arr.find(x => x.q === key); return f ? f.res : '-'; }
        function formatNoDecimal(v) { const n = parseFloat((v||'').toString().replace(/,/g,'')); return isNaN(n) ? (v||'-') : n.toLocaleString('en-US', {maximumFractionDigits:0}); }
        function openDetail(id) { 
            const rec = auditRecords.find(r => r.id == id); if(!rec) return; 
            const nplB = formatNoDecimal(getVal(rec.details, 'NPL (‡∏ö‡∏≤‡∏ó)'));
            const ar = formatNoDecimal(getVal(rec.details, 'AR'));
            const netAr = formatNoDecimal(getVal(rec.details, 'NET AR')); 
            const p = (v) => v !== '-' ? v+'%' : '-'; 
            
            // Generate Main Info
            let content = `<div class="text-center mb-6 pb-4 border-b-2 border-primary"><h2 class="text-2xl font-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h2><div class="flex justify-between text-sm"><span>${rec.branch}</span><span>${rec.date}</span></div></div> <table class="w-full text-xs border-collapse border border-slate-300 mb-6"> <tr class="bg-slate-50"><td colspan="5" class="border border-slate-300 p-4 text-center text-slate-500 font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤</td></tr> <tr><td class="border p-2 text-center" width="20%"><div class="font-bold text-slate-500">‡πÑ‡∏ã‡∏ï‡πå</div><div>${getVal(rec.details, '‡πÑ‡∏ã‡∏ï‡πå')}</div></td> <td class="border p-2 text-center" width="20%"><div class="font-bold text-slate-500">‡πÄ‡∏õ‡πâ‡∏≤</div><div>${getVal(rec.details, '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢')}</div></td> <td class="border p-2 text-center" width="20%"><div class="font-bold text-slate-500">‡∏ó‡∏≥‡πÑ‡∏î‡πâ</div><div>${getVal(rec.details, '‡∏¢‡∏≠‡∏î‡∏ó‡∏≥‡πÑ‡∏î‡πâ')}</div></td> <td class="border p-2 text-center" width="20%"><div class="font-bold text-slate-500">OD1</div><div>${p(getVal(rec.details, 'OD1 %'))}</div></td> <td class="border p-2 text-center" width="20%"><div class="font-bold text-slate-500">OD2</div><div>${p(getVal(rec.details, 'OD2 %'))}</div></td></tr> <tr><td class="border p-2 text-center"><div class="font-bold text-slate-500">OD3</div><div>${p(getVal(rec.details, 'OD3 %'))}</div></td> <td class="border p-2 text-center"><div class="font-bold text-slate-500">NPL%</div><div>${p(getVal(rec.details, 'NPL %'))}</div></td> <td class="border p-2 text-center"><div class="font-bold text-slate-500">NPL(‡∏ö‡∏≤‡∏ó)</div><div class="text-red-600 font-bold">${nplB}</div></td> <td class="border p-2 text-center"><div class="font-bold text-slate-500">AR</div><div>${ar}</div></td> <td class="border p-2 text-center"><div class="font-bold text-slate-500">NET AR</div><div>${netAr}</div></td></tr> </table>`; 
            
            let employeeContent = ''; let foundNewEmp = false;
            for(let i=0; i<10; i++) {
                const eid = getVal(rec.details, `emp_id_${i}`); const fname = getVal(rec.details, `emp_firstname_${i}`);
                if(eid !== '-' || fname !== '-') {
                    foundNewEmp = true;
                    const empName = `${fname} ${getVal(rec.details, `emp_lastname_${i}`)} (${eid})`;
                    employeeContent += `<div class="bg-slate-50 border border-slate-200 p-4 rounded-xl mb-6">
                        <h4 class="font-bold text-lg text-purple-700 border-b pb-2 mb-3"><i class="fa-solid fa-user mr-2"></i>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${empName}</h4>
                        ${genMatrixTable('‡∏ó‡∏±‡∏Å‡∏©‡∏∞', [{label:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', key:`rate_person_${i}`}, {label:'‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', key:`rate_sale_${i}`}], rec.details)}
                        ${genMatrixTable('‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå', [{label:'‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ M', key:`rate_k_m_${i}`}, {label:'‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ CTV', key:`rate_k_ctv_${i}`}, {label:'‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ HL', key:`rate_k_hl_${i}`}, {label:'‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', key:`rate_k_promo_${i}`}], rec.details)}`;
                    const empNote = getVal(rec.details, `emp_note_${i}`);
                    if(empNote && empNote !== '-') employeeContent += `<div class="mt-3 text-sm bg-white p-2 border border-slate-200 rounded text-slate-600"><span class="font-bold text-slate-800">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</span> ${empNote}</div>`;
                    employeeContent += `</div>`;
                }
            }
            if(!foundNewEmp) {
                const empName = `${getVal(rec.details, '‡∏ä‡∏∑‡πà‡∏≠')} ${getVal(rec.details, '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•')} (${getVal(rec.details, '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')})`;
                employeeContent += `<div class="bg-slate-50 border border-slate-200 p-4 rounded-xl mb-6">
                    <h4 class="font-bold text-lg text-purple-700 border-b pb-2 mb-3"><i class="fa-solid fa-user mr-2"></i>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${empName}</h4>
                    ${genMatrixTable('‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', [{label:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', key:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û'}, {label:'‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', key:'‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'}], rec.details)}
                    ${genMatrixTable('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå', [{label:'‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ M', key:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤M'}, {label:'‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ CTV', key:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤CTV'}, {label:'‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ HL', key:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤HL'}, {label:'‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', key:'‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô'}], rec.details)}
                </div>`;
            }
            content += employeeContent;
            content += genMatrixTable('‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≤‡∏Ç‡∏≤ (5‡∏™.)', [{label:'‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤', key:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤'}, {label:'‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', key:'‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'}, {label:'‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°', key:'‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°'}, {label:'‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', key:'‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥'}, {label:'‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á', key:'‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á'}, {label:'‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤', key:'‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤'}], rec.details); 
            
            const note = getVal(rec.details, 'area_comment'); if(note && note !== '-') content += `<div class="text-xs italic mt-2">* ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${note}</div>`; 
            
            // Checklist Section
            content += `<h4 class="font-bold mt-6 mb-2 border-b">Checklist</h4>`; 
            const checklistItems = [];
            rec.details.forEach(d => { 
                if(!['‡πÑ‡∏ã‡∏ï‡πå','‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','‡∏¢‡∏≠‡∏î‡∏ó‡∏≥‡πÑ‡∏î‡πâ','% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤','OD1 %','OD2 %','OD3 %','NPL %','NPL (‡∏ö‡∏≤‡∏ó)','AR','NET AR','‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡∏ä‡∏∑‡πà‡∏≠','‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•','‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û','‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤M','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤CTV','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤HL','‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤','‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô','‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°','‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á','‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤','area_comment'].includes(d.q) 
                    && !d.q.match(/_(0|1|2|3|4|5|6|7|8|9)$/)) { 
                    checklistItems.push(d); 
                } 
            });
            
            content += genChecklistTable(checklistItems);
            
            let sig = rec.signature; if(sig && sig.includes('drive')) sig = fixDriveUrl(sig); content += `<div class="mt-8 text-center border p-4 rounded"><img src="${sig}" class="h-16 mx-auto"><div class="text-xs mt-2">${rec.auditor}</div></div>`; document.getElementById('detailContent').innerHTML = content; document.getElementById('detailModal').classList.remove('hidden'); 
        }
        
        // --- NEW MATRIX TABLE GENERATOR ---
        function genMatrixTable(title, fields, details) {
            let h = `<h4 class="font-bold mt-4 mb-2 text-sm bg-slate-100 p-1 pl-2 border-l-4 border-slate-500">${title}</h4>`;
            h += `<table class="w-full text-xs border-collapse border border-slate-300">`;
            h += `<tr class="bg-slate-50">
                    <th class="border border-slate-300 p-1 text-left">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                    <th class="border border-slate-300 p-1 w-8 text-center">1</th>
                    <th class="border border-slate-300 p-1 w-8 text-center">2</th>
                    <th class="border border-slate-300 p-1 w-8 text-center">3</th>
                    <th class="border border-slate-300 p-1 w-8 text-center">4</th>
                    <th class="border border-slate-300 p-1 w-8 text-center">5</th>
                  </tr>`;
            
            fields.forEach(f => {
                const val = getVal(details, f.key); // Expected "1", "2", etc.
                h += `<tr>`;
                h += `<td class="border border-slate-300 p-1">${f.label}</td>`;
                for(let i=1; i<=5; i++) {
                    const mark = (val == i) ? '<span style="font-weight:bold; color:green; font-size:14px;">&#10003;</span>' : '';
                    h += `<td class="border border-slate-300 p-1 text-center">${mark}</td>`;
                }
                h += `</tr>`;
            });
            return h + '</table>';
        }

        // --- NEW CHECKLIST TABLE GENERATOR ---
        function genChecklistTable(items) {
            if(items.length === 0) return '<div class="text-xs text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
            
            let h = `<table class="w-full text-xs border-collapse border border-slate-300">`;
            h += `<tr class="bg-slate-50">
                    <th class="border border-slate-300 p-1 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th class="border border-slate-300 p-1 w-12 text-center">‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th class="border border-slate-300 p-1 w-12 text-center">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th class="border border-slate-300 p-1 text-left">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                  </tr>`;
            
            items.forEach(d => {
                const isPass = d.res === '‡∏ú‡πà‡∏≤‡∏ô';
                const isFail = d.res === '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
                const passMark = isPass ? '<span style="font-weight:bold; color:green; font-size:14px;">&#10003;</span>' : '';
                const failMark = isFail ? '<span style="font-weight:bold; color:red; font-size:14px;">&#10003;</span>' : '';
                
                h += `<tr>`;
                h += `<td class="border border-slate-300 p-1">${d.q}</td>`;
                h += `<td class="border border-slate-300 p-1 text-center bg-green-50/30">${passMark}</td>`;
                h += `<td class="border border-slate-300 p-1 text-center bg-red-50/30">${failMark}</td>`;
                
                let extra = d.note || '';
                if(d.image) {
                     extra += `<br><img src="${fixDriveUrl(d.image)}" style="max-height:120px; width:auto; margin-top:5px; border:1px solid #ddd;">`;
                }
                h += `<td class="border border-slate-300 p-1 text-gray-600 align-top">${extra}</td>`;
                h += `</tr>`;
            });
            return h + '</table>';
        }

        function downloadExcel() { const template = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>${document.getElementById('detailContent').innerHTML}</body></html>`; const blob = new Blob([template], {type: 'application/vnd.ms-excel'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Audit_Report_${new Date().toISOString().slice(0,10)}.xls`; a.click(); }
        function printReport() { const iframe = document.createElement('iframe'); document.body.appendChild(iframe); const doc = iframe.contentWindow.document; doc.write(`<html><head><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet"><style>body{font-family:'Sarabun';font-size:12px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:4px} img{max-height:150px}</style></head><body>${document.getElementById('detailContent').innerHTML}</body><script>window.onload=function(){setTimeout(function(){window.print();},1000)}<\/script></html>`); doc.close(); setTimeout(() => document.body.removeChild(iframe), 5000); }
        // Change Password Logic
        function openChangePasswordModal() { document.getElementById('changePasswordModal').classList.remove('hidden'); document.getElementById('cp_oldPass').value=''; document.getElementById('cp_newPass').value=''; document.getElementById('cp_confirmPass').value=''; }
        async function handleChangePasswordSubmit(e) {
            e.preventDefault(); const old=document.getElementById('cp_oldPass').value, np=document.getElementById('cp_newPass').value, cp=document.getElementById('cp_confirmPass').value;
            if(np!==cp) return showPopup('error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', '');
            toggleLoading(true);
            // Verify old password by logging in
            const v = await callAPI('login', { user: currentUser.user, pass: old });
            if(!v.success) { toggleLoading(false); return showPopup('error', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', ''); }
            
            // Update password
            const res = await callAPI('editUser', { user: currentUser.user, name: currentUser.name, role: currentUser.role, pass: np });
            toggleLoading(false);
            if(res.success) { 
                document.getElementById('changePasswordModal').classList.add('hidden'); 
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success'); 
            } else { 
                showPopup('error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message); 
            }
        }

        // Setup Helpers
        async function deleteAudit(id) { const c = await Swal.fire({ title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }); if(c.isConfirmed) { toggleLoading(true); await callAPI('deleteAudit', { auditId: id }); toggleLoading(false); fetchHistory(); } }
        async function fetchUsers() { 
            toggleLoading(true);
            const res=await callAPI('getUsers'); 
            toggleLoading(false);
            if(res.success) {
                document.getElementById('userListContainerBody').innerHTML = res.data.map(u => `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-3">
                            <div class="font-bold text-slate-700">${u.user}</div>
                            <div class="text-xs text-slate-400">${u.name}</div>
                        </td>
                        <td class="p-3 text-sm">${u.role}</td>
                        <td class="p-3 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick='openEditUserModal(${JSON.stringify(u)})' class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteUser('${u.user}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`).join(''); 
            }
        }
        
        function openEditUserModal(u) {
            document.getElementById('editUsername').value = u.user;
            document.getElementById('editName').value = u.name;
            document.getElementById('editRole').value = u.role;
            document.getElementById('editPermissionArea').value = u.permissionArea || '';
            document.getElementById('editPass').value = ''; // Reset password field
            document.getElementById('editUserModal').classList.remove('hidden');
        }
        
        async function handleEditUserSubmit(e) {
            e.preventDefault();
            const u = document.getElementById('editUsername').value;
            const n = document.getElementById('editName').value;
            const r = document.getElementById('editRole').value;
            const p = document.getElementById('editPermissionArea').value;
            const pass = document.getElementById('editPass').value;
            
            toggleLoading(true);
            const res = await callAPI('editUser', { user: u, name: n, role: r, permissionArea: p, pass: pass });
            toggleLoading(false);
            
            if(res.success) {
                document.getElementById('editUserModal').classList.add('hidden');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                fetchUsers();
            } else {
                showPopup('error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message);
            }
        }

        async function deleteUser(u) { const c=await Swal.fire({title:'‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?',text:u,icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}); if(c.isConfirmed) { toggleLoading(true); await callAPI('deleteUser',{targetUser:u}); toggleLoading(false); fetchUsers(); } }
        async function handleAddUser(e) { e.preventDefault(); toggleLoading(true); await callAPI('addUser', { user: e.target.newUsername.value, pass: e.target.newPassword.value, name: e.target.newName.value, role: e.target.newRole.value, permissionArea: e.target.newPermissionArea.value }); toggleLoading(false); fetchUsers(); e.target.reset(); }
        async function fetchLogs() { 
            const year = document.getElementById('logFilterYear').value; const checkedBoxes = document.querySelectorAll('.log-month-checkbox:checked'); const months = Array.from(checkedBoxes).map(cb => cb.value); updateMonthLabel('log', 'logMonthSelectLabel'); toggleLoading(true); const res=await callAPI('getLogs', { year: year, months: months }); toggleLoading(false); if(res.success) { if(res.data.length === 0) { document.getElementById('systemLogsContainer').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</td></tr>'; } else { document.getElementById('systemLogsContainer').innerHTML = res.data.map(l=>`<tr class="border-b"><td class="p-2 text-xs">${l.timestamp}</td><td class="p-2 font-bold">${l.user}</td><td class="p-2 text-xs">${l.role}</td><td class="p-2 text-xs">${l.action}</td><td class="p-2 text-xs">${l.details}</td></tr>`).join(''); } }
        }
        function genReportTable(title, fields, details) { let h=`<h4 class="font-bold mt-4 mb-2 text-sm bg-slate-100 p-1 pl-2 border-l-4 border-slate-500">${title}</h4><table class="w-full text-xs">`; fields.forEach(f=>{ h+=`<tr><td class="font-bold text-gray-500 w-1/2">${f.label}</td><td>${getVal(details,f.key)}</td></tr>`; }); return h+'</table>'; }

    </script>
</body>
</html>
