<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit System Pro - Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        primary: '#4f46e5', secondary: '#1e293b', accent: '#3b82f6',
                        success: '#10b981', warning: '#f59e0b', danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-link.active { background-color: rgba(255, 255, 255, 0.1); border-left: 4px solid #6366f1; }
        canvas#signaturePad { cursor: crosshair; touch-action: none; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; z-index: 1000; background: white; }
        }
        
        /* --- LOADER --- */
        .loader { width: 48px; height: 48px; display: inline-block; position: relative; border: 2px solid #FFF; box-sizing: border-box; animation: rotation 2s linear infinite; }
        .loader::after, .loader::before { content: ''; box-sizing: border-box; position: absolute; left: 0; right: 0; top: 0; bottom: 0; margin: auto; border: 2px solid #FF3D00; width: 38px; height: 38px; animation: rotationBack 1.5s linear infinite; transform-origin: center center; }
        .loader::before { width: 28px; height: 28px; border-color: #FFF; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
        @keyframes rotationBack { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }

        /* --- MODERN FORM CSS (เฉพาะส่วนฟอร์ม) --- */
        .form-card { @apply bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden transition-all hover:shadow-md; }
        .form-header { @apply flex items-center gap-3 mb-6 pb-3 border-b border-slate-50; }
        .form-title { @apply text-lg font-bold text-slate-800; }
        .form-label { @apply block text-sm font-bold text-slate-600 mb-2; }
        .form-input { 
            @apply w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-700 transition-all;
            @apply focus:bg-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none;
        }

        /* Modern Rating 1-5 */
        .rating-wrapper { @apply flex gap-2; }
        .rating-radio { @apply hidden peer; }
        .rating-box { 
            @apply w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-lg border border-slate-200 bg-white text-slate-400 font-bold cursor-pointer transition-all shadow-sm;
            @apply hover:border-primary hover:text-primary hover:-translate-y-1;
            @apply peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white peer-checked:shadow-lg peer-checked:scale-110;
        }

        /* Modern Switch Yes/No */
        .switch-wrapper { @apply flex bg-slate-100 p-1 rounded-lg w-fit; }
        .switch-radio { @apply hidden peer; }
        .switch-label { 
            @apply px-4 py-2 rounded-md text-sm font-bold text-slate-500 cursor-pointer transition-all flex items-center gap-2;
            @apply hover:text-slate-700;
        }
        /* State Styles */
        .switch-radio[value="ผ่าน"]:checked + .switch-label { @apply bg-green-500 text-white shadow-sm; }
        .switch-radio[value="ไม่ผ่าน"]:checked + .switch-label { @apply bg-red-500 text-white shadow-sm; }
        
        /* Section Decorator */
        .section-tag { @apply w-1.5 h-6 rounded-r-full absolute left-0 top-8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen overflow-hidden flex flex-col">

    <div id="print-area" class="hidden bg-white text-black p-10"></div>

    <div id="view-login" class="fixed inset-0 z-50 flex bg-white fade-in">
        <div class="hidden lg:flex w-1/2 bg-slate-900 relative items-center justify-center overflow-hidden">
            <div class="absolute inset-0 opacity-20">
                <i class="fa-solid fa-chart-line text-[20rem] absolute -bottom-20 -left-20 text-white transform rotate-12"></i>
                <i class="fa-solid fa-shield-halved text-[15rem] absolute top-10 right-10 text-white opacity-50"></i>
            </div>
            <div class="relative z-10 text-center text-white px-10">
                <div class="mb-6 inline-block p-4 rounded-full bg-white/10 backdrop-blur-lg border border-white/20 shadow-2xl">
                    <i class="fa-solid fa-database text-6xl text-green-400"></i>
                </div>
                <h1 class="text-4xl font-bold mb-4 tracking-wide">Audit System Pro</h1>
                <p class="text-slate-300 text-lg max-w-md mx-auto leading-relaxed">ระบบบริหารจัดการและตรวจสอบมาตรฐานสาขาแบบครบวงจร</p>
                <div class="mt-8 flex justify-center gap-2">
                    <span class="px-3 py-1 bg-white/10 rounded-full text-xs border border-white/20">v4.2 BeautifulForm</span>
                    <span class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-xs border border-green-500/30">● Online</span>
                </div>
            </div>
        </div>
        <div class="w-full lg:w-1/2 flex items-center justify-center p-8 bg-slate-50">
            <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                <div class="mb-8 text-center lg:text-left">
                    <h2 class="text-3xl font-bold text-slate-800">เข้าสู่ระบบ</h2>
                    <p class="text-slate-500 mt-2">กรุณาระบุบัญชีผู้ใช้เพื่อเข้าถึงระบบ</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Username</label>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="text" id="loginUser" class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" placeholder="Username" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                        <div class="relative">
                            <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="password" id="loginPass" class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" placeholder="Password" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3.5 rounded-lg shadow-lg hover:shadow-indigo-500/30 transition transform active:scale-[0.98]">
                        เข้าสู่ระบบ
                    </button>
                    <div class="mt-6 text-center">
                        <p class="text-xs text-slate-400 select-none">Version 4.2</p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="main-layout" class="hidden flex h-screen overflow-hidden bg-slate-100">
        <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden transition-opacity" onclick="toggleSidebar()"></div>

        <aside id="appSidebar" class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col transition-transform duration-300 z-30 shadow-2xl fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0">
            <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800 justify-between md:justify-start">
                <div class="flex items-center">
                    <i class="fa-solid fa-shield-halved text-primary text-2xl mr-3"></i>
                    <span class="font-bold text-lg tracking-wide">Audit Pro</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 border-b border-slate-800 bg-slate-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-primary to-accent flex items-center justify-center font-bold text-white shadow-lg border border-white/10">
                        <span id="sidebarAvatar">?</span>
                    </div>
                    <div class="overflow-hidden">
                        <p id="sidebarName" class="text-sm font-semibold truncate max-w-[120px]">User</p>
                        <p id="sidebarRole" class="text-xs text-slate-400 uppercase tracking-wider">-</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
                <a href="#" onclick="switchView('view-dashboard'); toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-chart-pie w-6 group-hover:text-primary transition-colors"></i><span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="switchView('view-audit'); toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-clipboard-check w-6 group-hover:text-success transition-colors"></i><span class="font-medium">เริ่มตรวจสาขา</span>
                </a>
                <a href="#" onclick="switchView('view-history'); toggleSidebar();" class="nav-link flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-clock-rotate-left w-6 group-hover:text-warning transition-colors"></i><span class="font-medium">ประวัติการตรวจ</span>
                </a>
                <div class="pt-4 pb-2 px-4 text-xs font-bold text-slate-500 uppercase tracking-widest admin-only hidden">Administrator</div>
                <a href="#" onclick="switchView('view-users'); toggleSidebar();" class="nav-link admin-only hidden flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-users-gear w-6 group-hover:text-purple-400 transition-colors"></i><span class="font-medium">จัดการผู้ใช้งาน</span>
                </a>
                <a href="#" onclick="switchView('view-questions'); toggleSidebar();" class="nav-link admin-only hidden flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-list-check w-6 group-hover:text-pink-400 transition-colors"></i><span class="font-medium">ตั้งค่าแบบฟอร์ม</span>
                </a>
                <a href="#" onclick="switchView('view-logs'); toggleSidebar();" class="nav-link admin-only hidden flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                    <i class="fa-solid fa-file-shield w-6 group-hover:text-cyan-400 transition-colors"></i><span class="font-medium">System Logs</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-800 text-center">
                <div class="text-[10px] text-slate-500 mb-2 font-mono">System v4.2</div>
                <button type="button" onclick="logout()" class="w-full flex items-center justify-center gap-2 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white px-4 py-2 rounded-lg transition-all text-sm font-bold">
                    <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-full relative w-full">
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-4 sm:px-6 z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <button class="md:hidden text-slate-500 hover:text-primary focus:outline-none p-1 rounded-md active:bg-slate-100" onclick="toggleSidebar()"><i class="fa-solid fa-bars text-xl"></i></button>
                    <h2 id="pageTitle" class="text-lg sm:text-xl font-bold text-slate-800 truncate">ภาพรวมระบบ</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex items-center text-sm text-green-600 bg-green-50 px-3 py-1.5 rounded-full border border-green-200 shadow-sm"><i class="fa-solid fa-wifi mr-2 animate-pulse"></i><span id="connectionStatus">Online</span></div>
                    <div class="sm:hidden text-green-600 text-xs flex items-center gap-1"><i class="fa-solid fa-circle text-[8px]"></i> Online</div>
                    <button type="button" onclick="logout()" class="md:hidden w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-500 active:bg-red-100 ml-2"><i class="fa-solid fa-right-from-bracket text-sm"></i></button>
                </div>
            </header>

            <main id="mainContent" class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8 relative w-full bg-slate-50">
                <div id="view-dashboard" class="page-view fade-in space-y-6">
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                        <div onclick="filterDashboard('all')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md hover:border-primary/50 transition group"><div><p class="text-sm font-medium text-slate-500 group-hover:text-primary transition">สาขาทั้งหมด</p><h3 id="dashTotalBranches" class="text-3xl font-bold text-slate-800 mt-1">0</h3></div><div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition"><i class="fa-solid fa-store"></i></div></div>
                        <div onclick="filterDashboard('all')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md hover:border-success/50 transition group"><div><p class="text-sm font-medium text-slate-500 group-hover:text-success transition">ตรวจแล้ว</p><h3 id="dashAudited" class="text-3xl font-bold text-success mt-1">0</h3></div><div class="w-12 h-12 rounded-full bg-green-50 text-green-600 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition"><i class="fa-solid fa-check-circle"></i></div></div>
                        <div onclick="showRemainingBranches()" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md hover:border-warning/50 transition group"><div><p class="text-sm font-medium text-slate-500 group-hover:text-warning transition">คงเหลือ</p><h3 id="dashRemaining" class="text-3xl font-bold text-warning mt-1">0</h3></div><div class="w-12 h-12 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition"><i class="fa-solid fa-hourglass-half"></i></div></div>
                        <div onclick="filterDashboard('fail')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md hover:border-danger/50 transition group"><div><p class="text-sm font-medium text-slate-500 group-hover:text-danger transition">ต้องแก้ไข</p><h3 id="dashFailCount" class="text-3xl font-bold text-danger mt-1">0</h3></div><div class="w-12 h-12 rounded-full bg-red-50 text-red-500 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition"><i class="fa-solid fa-triangle-exclamation"></i></div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm"><h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-line text-primary"></i> แนวโน้มผลการตรวจ (รายเดือน)</h3><canvas id="trendChart" class="w-full max-h-64"></canvas></div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm"><h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> 5 อันดับหัวข้อที่ตกบ่อยที่สุด</h3><canvas id="failChart" class="w-full max-h-64"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm overflow-hidden"><div class="flex items-center justify-between mb-6"><h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-primary"></i> สถานะสาขาล่าสุด</h3></div><div id="zoneStatList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm"><div class="col-span-full text-center py-4 text-slate-400">กำลังโหลดข้อมูล...</div></div></div>
                </div>

                <div id="view-audit" class="page-view fade-in hidden max-w-5xl mx-auto pb-20">
                    <div id="draftNotice" class="hidden mb-6 bg-amber-50 text-amber-800 p-5 rounded-2xl flex flex-col sm:flex-row justify-between items-center border border-amber-200 shadow-sm gap-4">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-clock-rotate-left text-amber-500 text-xl"></i>
                            <div><span class="font-bold">พบข้อมูลร่างล่าสุด</span> <span class="text-sm opacity-80">คุณต้องการกู้คืนหรือไม่?</span></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearDraft()" class="px-4 py-2 text-slate-500 hover:text-slate-800 font-bold text-sm">ลบทิ้ง</button>
                            <button onclick="restoreDraft(JSON.parse(localStorage.getItem(STORAGE.DRAFT)))" class="px-6 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg shadow-sm font-bold text-sm">กู้คืนข้อมูล</button>
                        </div>
                    </div>

                    <div class="mb-6 flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">บันทึกการตรวจสาขา</h2>
                            <p class="text-slate-500 text-sm">กรุณากรอกข้อมูลตามความเป็นจริงเพื่อมาตรฐาน</p>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Today</div>
                            <div class="text-primary font-mono font-bold" id="headerDate">-</div>
                        </div>
                    </div>
                    
                    <form id="auditForm" onsubmit="submitAudit(event)" oninput="saveDraft()" class="space-y-2">
                        
                        <div class="form-card">
                            <div class="section-tag bg-blue-500"></div>
                            <div class="form-header">
                                <i class="fa-solid fa-store text-blue-500 text-xl"></i>
                                <h4 class="form-title">ข้อมูลสาขา (Branch Info)</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                <div class="lg:col-span-2">
                                    <label class="form-label">พิกัด GPS <span class="text-red-500">*</span></label>
                                    <div class="flex gap-2">
                                        <input type="text" id="gpsCoords" class="form-input font-mono bg-slate-100 text-slate-500" readonly placeholder="กดปุ่ม Check-in">
                                        <button type="button" onclick="getLocation()" class="bg-blue-600 text-white px-5 rounded-xl hover:bg-blue-700 transition shadow-lg active:scale-95 font-bold whitespace-nowrap"><i class="fa-solid fa-location-dot mr-1"></i> Check-in</button>
                                    </div>
                                </div>
                                <div><label class="form-label">เวลาเข้าเยี่ยม</label><input type="text" class="form-input bg-slate-100 text-center font-bold text-blue-600" id="visitDate" readonly></div>
                                
                                <div><label class="form-label">เขต (Zone)</label><div class="relative"><select id="zoneSelect" onchange="handleZoneChange()" class="form-input appearance-none"><option value="">-- รอข้อมูล --</option></select><i class="fa-solid fa-chevron-down absolute right-4 top-4 text-slate-400 pointer-events-none"></i></div></div>
                                <div><label class="form-label">สาขา (Branch)</label><div class="relative"><select id="branchSelect" class="form-input appearance-none disabled:bg-slate-100" disabled><option value="">-- เลือกเขตก่อน --</option></select><i class="fa-solid fa-chevron-down absolute right-4 top-4 text-slate-400 pointer-events-none"></i></div></div>
                                <div><label class="form-label">ไซต์สาขา</label><input type="text" id="f_site" class="form-input" placeholder="S, M, L"></div>
                                
                                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-5 bg-blue-50/50 p-4 rounded-xl border border-blue-100 mt-2">
                                    <div><label class="form-label text-blue-800">เป้าสาขา</label><input type="number" id="f_target" class="form-input bg-white border-blue-200"></div>
                                    <div><label class="form-label text-blue-800">ยอดทำได้จริง</label><input type="number" id="f_actual" class="form-input bg-white border-blue-200"></div>
                                    <div><label class="form-label text-blue-800">% เทียบเป้า</label><input type="text" id="f_percent" class="form-input bg-white border-blue-200 font-bold text-blue-600"></div>
                                </div>
                                
                                <div class="hidden"><input id="f_age"><input id="f_lease"><input id="f_ar"><input id="f_acc_count"><input id="f_od1"><input id="f_od2"><input id="f_npl"><input id="f_npl_ar"><input id="f_npl_acc"></div>
                            </div>
                        </div>

                        <div class="form-card">
                            <div class="section-tag bg-purple-500"></div>
                            <div class="form-header">
                                <i class="fa-solid fa-user-tie text-purple-500 text-xl"></i>
                                <h4 class="form-title">พนักงาน (Employee)</h4>
                            </div>
                            <div class="space-y-6">
                                <div><label class="form-label">ชื่อพนักงาน</label><input type="text" id="emp_name" class="form-input text-lg font-bold" placeholder="ระบุชื่อพนักงาน..."></div>
                                
                                <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                                    <h5 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-star text-yellow-400"></i> การประเมิน (5=ดีมาก)</h5>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div><label class="form-label">บุคลิกภาพ/การแต่งกาย</label><div class="rating-wrapper" id="rate_person"></div></div>
                                        <div><label class="form-label">ทักษะการขาย</label><div class="rating-wrapper" id="rate_sale"></div></div>
                                    </div>
                                </div>
                                
                                <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                                    <h5 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-brain text-purple-400"></i> ความรู้ผลิตภัณฑ์</h5>
                                    <div class="space-y-4">
                                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-2"><span class="text-sm font-medium">สินเชื่อ M</span><div class="rating-wrapper" id="rate_k_m"></div></div>
                                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-2"><span class="text-sm font-medium">สินเชื่อ CTV</span><div class="rating-wrapper" id="rate_k_ctv"></div></div>
                                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-2"><span class="text-sm font-medium">สินเชื่อ HL</span><div class="rating-wrapper" id="rate_k_hl"></div></div>
                                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-2"><span class="text-sm font-medium">โปรโมชั่น</span><div class="rating-wrapper" id="rate_k_promo"></div></div>
                                    </div>
                                </div>
                                <div class="hidden"><input id="k_insure"><input id="p_target_contract"><input id="p_actual_contract"><input id="p_target_amount"><input id="p_actual_amount"><input id="txt_strength"><input id="txt_weakness"><input id="txt_suggestion"></div>
                            </div>
                        </div>

                        <div class="form-card">
                            <div class="section-tag bg-orange-500"></div>
                            <div class="form-header">
                                <i class="fa-solid fa-broom text-orange-500 text-xl"></i>
                                <h4 class="form-title">สภาพสาขา (5ส.)</h4>
                            </div>
                            <div class="space-y-4 bg-slate-50 p-5 rounded-xl border border-slate-100">
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-3"><span class="text-sm font-bold text-slate-600">ความสะอาดหน้าสาขา</span><div class="rating-wrapper" id="rate_c_branch"></div></div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-3"><span class="text-sm font-bold text-slate-600">โต๊ะทำงาน/อุปกรณ์</span><div class="rating-wrapper" id="rate_c_desk"></div></div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-3"><span class="text-sm font-bold text-slate-600">จุดบริการน้ำดื่ม</span><div class="rating-wrapper" id="rate_c_coffee"></div></div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-3"><span class="text-sm font-bold text-slate-600">ห้องน้ำ</span><div class="rating-wrapper" id="rate_c_toilet"></div></div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-3"><span class="text-sm font-bold text-slate-600">พื้นที่เก็บของ</span><div class="rating-wrapper" id="rate_c_storage"></div></div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 border-b border-slate-200 pb-3"><span class="text-sm font-bold text-slate-600">หลังสาขา</span><div class="rating-wrapper" id="rate_c_back"></div></div>
                            </div>
                            <div class="mt-4"><label class="form-label">บันทึกสภาพแวดล้อมเพิ่มเติม</label><textarea id="area_comment" rows="2" class="form-input" placeholder="..."></textarea></div>
                            <div class="hidden"><input id="area_comp_near"><input id="area_comp_dist"><input id="area_sign"><input id="area_env"><input id="rate_area_target"></div>
                        </div>

                        <div class="form-card">
                            <div class="section-tag bg-pink-500"></div>
                            <div class="form-header">
                                <i class="fa-solid fa-list-check text-pink-500 text-xl"></i>
                                <h4 class="form-title">รายการตรวจสอบ (Checklist)</h4>
                            </div>
                            <div id="questionsContainer" class="space-y-4"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <label class="form-label text-lg"><i class="fa-solid fa-comment-dots text-primary mr-2"></i> สรุปผลการตรวจ</label>
                                <textarea id="summaryComment" rows="5" class="form-input h-40 resize-none" placeholder="สรุปภาพรวม..."></textarea>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col">
                                <div class="flex justify-between mb-2">
                                    <label class="form-label text-lg"><i class="fa-solid fa-signature text-primary mr-2"></i> ลายเซ็น</label>
                                    <button type="button" onclick="clearSignature()" class="text-xs text-red-500 font-bold hover:underline">ล้างลายเซ็น</button>
                                </div>
                                <div class="flex-1 border-2 border-dashed border-slate-300 bg-slate-50 relative rounded-xl overflow-hidden h-40 cursor-crosshair">
                                    <canvas id="signaturePad" class="w-full h-full absolute inset-0"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col-reverse sm:flex-row items-center gap-4 pt-4 border-t border-slate-200">
                             <button type="button" onclick="switchView('view-dashboard')" class="w-full sm:w-auto px-8 py-3 rounded-xl border border-slate-300 text-slate-600 font-bold hover:bg-white transition">ยกเลิก</button>
                             <button type="submit" class="w-full sm:flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl hover:-translate-y-0.5 transition flex items-center justify-center gap-2 text-lg">
                                <i class="fa-solid fa-paper-plane"></i> บันทึกและส่งรายงาน
                             </button>
                        </div>
                    </form>
                </div>

                <div id="view-history" class="page-view fade-in hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-4 sm:p-6 bg-white border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">ประวัติการตรวจ</h3><button onclick="fetchHistory()" class="text-sm text-primary flex items-center gap-2 hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition"><i class="fa-solid fa-sync"></i> Refresh</button></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="bg-slate-50 border-b uppercase text-xs font-bold text-slate-500"><tr><th class="px-6 py-4 whitespace-nowrap">วันที่</th><th class="px-6 py-4 whitespace-nowrap">สาขา</th><th class="px-6 py-4 whitespace-nowrap">ผู้ตรวจ</th><th class="px-6 py-4 whitespace-nowrap">ผล</th><th class="px-6 py-4 text-center whitespace-nowrap">รายละเอียด</th></tr></thead><tbody id="auditLogContainer" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <div id="view-users" class="page-view fade-in hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                             <h3 class="font-bold mb-4 border-l-4 border-primary pl-3 text-slate-800">เพิ่มผู้ใช้งานใหม่</h3>
                             <form onsubmit="handleAddUser(event)" class="space-y-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Username</label><input name="newUsername" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Password</label><input name="newPassword" type="password" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Full Name</label><input name="newName" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Role</label><select name="newRole" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition"><option value="user">User (พนักงาน)</option><option value="admin">Admin (ผู้ดูแล)</option></select></div>
                                <button class="w-full bg-slate-800 text-white p-3 rounded-lg font-bold hover:bg-slate-700 transition mt-2"><i class="fa-solid fa-plus mr-2"></i> บันทึกข้อมูล</button>
                             </form>
                        </div>
                        <div class="md:col-span-2 bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                             <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-700">รายชื่อผู้ใช้งาน</h3><button onclick="fetchUsers()" class="text-primary text-xs font-bold hover:underline"><i class="fa-solid fa-sync"></i> Refresh</button></div>
                             <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="border-b bg-white text-slate-500 uppercase text-xs font-bold"><tr><th class="p-3 pl-6 text-left">User Info</th><th class="p-3 text-left">Role</th><th class="p-3 text-right pr-6">Action</th></tr></thead><tbody id="userListContainerBody" class="divide-y divide-slate-50"></tbody></table></div>
                        </div>
                     </div>
                </div>

                <div id="view-questions" class="page-view fade-in hidden max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800 text-lg flex items-center gap-2"><i class="fa-solid fa-list-check text-pink-500"></i> ตั้งค่าหัวข้อแบบฟอร์ม (Local)</h3><button onclick="resetQuestions()" class="text-xs text-red-500 hover:underline">Reset Default</button></div>
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6"><h4 class="font-bold text-sm text-slate-700 mb-2">เพิ่มหัวข้อใหม่</h4><form onsubmit="handleAddQuestion(event)" class="flex flex-col md:flex-row gap-3 items-end"><div class="flex-1 w-full"><label class="text-xs text-slate-500">หัวข้อหลัก</label><input type="text" name="qTitle" placeholder="เช่น ความปลอดภัย..." class="w-full p-2 border rounded-lg text-sm" required></div><div class="flex items-center gap-2 pb-2"><input type="checkbox" name="qAllowImg" id="newQImg" class="w-4 h-4 text-primary rounded border-gray-300"><label for="newQImg" class="text-sm text-slate-600 select-none">เปิดใช้อัปโหลดรูป</label></div><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium w-full md:w-auto"><i class="fa-solid fa-plus mr-1"></i> เพิ่ม</button></form></div>
                        <div id="questionsListConfig" class="space-y-3"></div>
                    </div>
                </div>

                <div id="view-logs" class="page-view fade-in hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-file-shield text-cyan-500"></i> บันทึกกิจกรรมระบบ (Server Logs)</h3><button onclick="fetchLogs()" class="text-sm text-primary hover:underline"><i class="fa-solid fa-sync"></i> Refresh</button></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="bg-slate-100 text-slate-700 uppercase font-bold text-xs"><tr><th class="px-6 py-4 whitespace-nowrap">เวลา</th><th class="px-6 py-4 whitespace-nowrap">ผู้ใช้งาน</th><th class="px-6 py-4 whitespace-nowrap">Role</th><th class="px-6 py-4 whitespace-nowrap">กิจกรรม</th><th class="px-6 py-4 whitespace-nowrap">รายละเอียด</th></tr></thead><tbody id="systemLogsContainer" class="divide-y divide-slate-100 font-mono text-xs"><tr><td colspan="5" class="text-center py-4">กำลังโหลดข้อมูล...</td></tr></tbody></table></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="detailModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] flex flex-col shadow-2xl animate-fade-in-up">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl"><h3 class="font-bold text-lg text-slate-800">รายละเอียดใบตรวจสอบ</h3><button onclick="document.getElementById('detailModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div id="detailPDFContainer" class="p-6 overflow-y-auto flex-1 text-sm space-y-4 bg-white"><div id="detailContent"></div></div>
            <div class="p-5 border-t border-slate-100 bg-white rounded-b-2xl flex gap-3"><button onclick="downloadPDF()" class="flex-1 bg-red-600 text-white py-2.5 rounded-lg hover:bg-red-700 font-medium transition flex items-center justify-center gap-2"><i class="fa-solid fa-file-pdf"></i> Download PDF</button><button onclick="printReport()" class="flex-1 bg-slate-800 text-white py-2.5 rounded-lg hover:bg-slate-700 font-medium transition flex items-center justify-center gap-2"><i class="fa-solid fa-print"></i> พิมพ์รายงาน</button></div>
        </div>
    </div>
    
    <div id="editUserModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl animate-fade-in-up">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800">แก้ไขข้อมูลผู้ใช้งาน</h3>
                <button onclick="document.getElementById('editUserModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="handleEditUserSubmit(event)" class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Username</label>
                    <input type="text" id="editUsername" name="user" class="w-full mt-1 p-2.5 bg-slate-100 border border-slate-200 rounded-lg text-slate-500 outline-none cursor-not-allowed" readonly>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
                    <input type="text" id="editName" name="name" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Role</label>
                    <select id="editRole" name="role" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">New Password (Optional)</label>
                    <input type="password" name="pass" placeholder="เว้นว่างถ้าไม่ต้องการเปลี่ยน" class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-primary transition">
                </div>
                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="document.getElementById('editUserModal').classList.add('hidden')" class="flex-1 py-2.5 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50">ยกเลิก</button>
                    <button type="submit" class="flex-1 bg-primary text-white py-2.5 rounded-lg hover:bg-indigo-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 z-[100] flex flex-col items-center justify-center transition-opacity duration-300">
        <span class="loader"></span>
        <p id="loadingText" class="font-bold text-white mt-4 text-lg animate-pulse shadow-black drop-shadow-md">กำลังประมวลผล...</p>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwQ3PAtmKc46CNCwKGYrMsULKja6P08LFh_b96w37L0CUCs9YSwMei6iiyxUxohFzf4/exec"; // *** เปลี่ยน URL ตรงนี้ ***
        const STORAGE = { QUESTIONS: 'app_v2_questions', DRAFT: 'app_v2_draft', USER: 'audit_user_session' };
        let currentUser = null;
        let branchData = {}; 
        let zoneList = [];
        let auditRecords = [];
        let currentAuditImages = {};
        let allBranchDetails = []; 
        let inactivityTimer;
        
        const defaultQuestions = [
            { id: 'q1', title: 'ตู้เซฟปิดล็อคเรียบร้อย', allowImage: true }, 
            { id: 'q2', title: 'เอกสารสำคัญเก็บเข้าตู้', allowImage: true }
        ];

        let questions = JSON.parse(localStorage.getItem(STORAGE.QUESTIONS)) || defaultQuestions;

        // Auto Logout Logic
        function startInactivityTimer() {
            resetTimer();
            window.addEventListener('mousemove', resetTimer);
            window.addEventListener('mousedown', resetTimer);
            window.addEventListener('keypress', resetTimer);
            window.addEventListener('touchmove', resetTimer);
            window.addEventListener('scroll', resetTimer);
        }

        function resetTimer() {
            clearTimeout(inactivityTimer);
            if (currentUser) {
                inactivityTimer = setTimeout(() => {
                    localStorage.removeItem(STORAGE.USER);
                    Swal.fire({
                        title: 'หมดเวลาการใช้งาน',
                        text: 'ระบบออกจากระบบอัตโนมัติเนื่องจากไม่มีการใช้งานเกิน 10 นาที',
                        icon: 'warning',
                        confirmButtonText: 'ตกลง'
                    }).then(() => {
                        location.reload();
                    });
                }, 600000); 
            }
        }

        window.addEventListener('load', () => {
            const storedUser = localStorage.getItem(STORAGE.USER);
            if(storedUser) {
                currentUser = JSON.parse(storedUser);
                initSystemAfterLogin();
            }
        });

        function initSystemAfterLogin() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('main-layout').classList.remove('hidden');
            document.getElementById('sidebarName').innerText = currentUser.name;
            document.getElementById('sidebarRole').innerText = currentUser.role;
            document.getElementById('sidebarAvatar').innerText = currentUser.name.charAt(0).toUpperCase();

            if (currentUser.role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('hidden'));
            else document.querySelectorAll('.admin-only').forEach(e => e.classList.remove('hidden'));

            fetchBranches(); 
            fetchHistory(false); 
            
            switchView('view-dashboard');
            startInactivityTimer();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('appSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden');
            }
        }

        function showPopup(type, title, text) { Swal.fire({ icon: type, title: title, text: text, confirmButtonColor: '#4f46e5', confirmButtonText: 'ตกลง', backdrop: `rgba(0,0,123,0.4)` }); }
        function toggleLoading(show, text = "กำลังประมวลผล...") { const overlay = document.getElementById('loadingOverlay'); const txt = document.getElementById('loadingText'); if(show) { txt.innerText = text; overlay.classList.remove('hidden'); } else { overlay.classList.add('hidden'); } }

        async function callAPI(action, payload = {}) {
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
                return await response.json();
            } catch (error) { return { success: false, message: error.message }; }
        }

        function switchView(viewId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'bg-slate-800', 'text-white'));
            document.getElementById(viewId).classList.remove('hidden');
            const activeLink = document.querySelector(`a[onclick*="switchView('${viewId}')"]`);
            if(activeLink) activeLink.classList.add('active', 'bg-slate-800', 'text-white');
            document.getElementById('pageTitle').innerText = viewId.replace('view-', '').toUpperCase();
            
            if (viewId === 'view-audit') { 
                initAuditForm(); 
                setTimeout(initSignature, 100); 
                document.getElementById('visitDate').value = new Date().toLocaleString('th-TH');
                document.getElementById('headerDate').innerText = new Date().toLocaleDateString('th-TH');
                checkDraft(); 
            }
            if (viewId === 'view-history') fetchHistory();
            if (viewId === 'view-users') fetchUsers();
            if (viewId === 'view-logs') fetchLogs(); 
            if (viewId === 'view-questions') renderQuestionsConfig();
            if (viewId === 'view-dashboard') fetchAnalytics();
        }

        async function handleLogin(e) {
            e.preventDefault();
            if(API_URL.includes("REPLACE")) { showPopup('error', 'Configuration Error', 'กรุณาใส่ API URL ในโค้ดก่อนใช้งาน'); return; }
            toggleLoading(true, "กำลังเข้าสู่ระบบ...");
            const res = await callAPI('login', { user: document.getElementById('loginUser').value, pass: document.getElementById('loginPass').value });
            toggleLoading(false);
            if (res.success) {
                currentUser = res.user;
                localStorage.setItem(STORAGE.USER, JSON.stringify(currentUser));
                initSystemAfterLogin();
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
                Toast.fire({ icon: 'success', title: `ยินดีต้อนรับ, ${currentUser.name}` });
                callAPI('logSystem', { user: currentUser.user, role: currentUser.role, logAction: 'LOGIN', details: 'Success' });
            } else { showPopup('error', 'เข้าสู่ระบบไม่สำเร็จ', res.message); }
        }

        function logout() {
            Swal.fire({
                title: 'ออกจากระบบ?',
                text: "คุณต้องการออกจากระบบหรือไม่",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then((res) => {
                if (res.isConfirmed) {
                    clearTimeout(inactivityTimer);
                    localStorage.removeItem(STORAGE.USER);
                    currentUser = null;
                    location.reload();
                }
            });
        }

        async function fetchBranches() {
            const res = await callAPI('getBranches');
            if (res.success) {
                branchData = {}; zoneList = []; allBranchDetails = [];
                res.data.forEach(item => {
                    if (!branchData[item.zone]) { branchData[item.zone] = []; zoneList.push(item.zone); }
                    branchData[item.zone].push({ id: item.id, name: item.name }); 
                    allBranchDetails.push(item);
                });
                updateDashboardCounts();
                document.getElementById('zoneStatList').innerHTML = zoneList.map(z => 
                    `<div class="bg-white p-4 rounded-lg border border-slate-100 text-center shadow-sm hover:shadow-md transition">
                        <div class="text-xs text-slate-400 mb-1">เขต</div><div class="font-bold text-primary text-lg">${z}</div><div class="text-xs text-slate-500 mt-1 bg-slate-50 rounded py-1">${branchData[z].length} สาขา</div>
                    </div>`
                ).join('');
            }
        }

        function updateDashboardCounts() {
             const totalBranches = allBranchDetails.length;
             if (totalBranches === 0) return;
             const auditedCount = auditRecords.length;
             const failCount = auditRecords.filter(r => r.result === 'ไม่ผ่าน').length;
             const uniqueAuditedBranches = new Set(auditRecords.map(r => r.branch)).size;
             const remaining = totalBranches - uniqueAuditedBranches;
             document.getElementById('dashTotalBranches').innerText = totalBranches;
             document.getElementById('dashAudited').innerText = auditedCount;
             document.getElementById('dashRemaining').innerText = remaining < 0 ? 0 : remaining;
             document.getElementById('dashFailCount').innerText = failCount;
        }

        async function filterDashboard(type) {
            switchView('view-history');
            if (auditRecords.length === 0) {
                toggleLoading(true, "กำลังโหลดข้อมูล...");
                await fetchHistory(false);
                toggleLoading(false);
            }
            let filteredRecords = [];
            let titleText = "";
            if (type === 'fail') {
                filteredRecords = auditRecords.filter(r => r.result === 'ไม่ผ่าน');
                titleText = "รายการที่ต้องแก้ไข (ไม่ผ่าน)";
            } else {
                filteredRecords = auditRecords;
                titleText = "ประวัติการตรวจทั้งหมด";
            }
            renderHistoryTable(filteredRecords);
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
            Toast.fire({ icon: 'info', title: `แสดง: ${titleText}` });
        }

        function showRemainingBranches() {
            const auditedBranchNames = new Set(auditRecords.map(r => r.branch));
            const remaining = allBranchDetails.filter(b => {
                const fullName = b.id && b.id !== '-' ? `[${b.id}] ${b.name}` : b.name;
                return !auditedBranchNames.has(fullName);
            });
            if (remaining.length === 0) {
                Swal.fire('ยอดเยี่ยม!', 'ตรวจครบทุกสาขาแล้ว', 'success');
                return;
            }
            let htmlList = `<div class="text-left max-h-60 overflow-y-auto space-y-2">`;
            remaining.forEach(b => {
                htmlList += `<div class="p-2 bg-slate-50 border rounded text-sm flex justify-between"><span>${b.name}</span> <span class="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600">${b.zone}</span></div>`;
            });
            htmlList += `</div>`;
            Swal.fire({ title: `สาขาที่คงเหลือ (${remaining.length})`, html: htmlList, confirmButtonText: 'ปิด' });
        }

        function renderHistoryTable(records) {
            const container = document.getElementById('auditLogContainer');
            if (records.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-400">ไม่พบข้อมูลตามเงื่อนไข</td></tr>`;
                return;
            }
            container.innerHTML = records.map(r => `
                <tr class="border-b hover:bg-slate-50 transition">
                    <td class="p-3">${r.date}</td>
                    <td class="p-3 font-bold text-slate-700">${r.branch}</td>
                    <td class="p-3 text-slate-600">${r.auditor}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded-md text-xs border ${r.result==='ผ่าน'?'bg-green-50 text-green-700 border-green-200':'bg-red-50 text-red-700 border-red-200'} font-bold">${r.result}</span></td>
                    <td class="p-3 text-center flex items-center justify-center gap-2">
                        <button onclick='openDetail("${r.id}")' class="text-primary text-xs border border-primary px-3 py-1 rounded hover:bg-primary hover:text-white transition">View</button>
                        ${currentUser && currentUser.role === 'admin' ? `<button onclick="deleteAudit('${r.id}')" class="text-red-500 text-xs border border-red-500 px-2 py-1 rounded hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </td>
                </tr>`).join('');
        }

        // --- UPDATED: New Rating Component Generator ---
        function genRating(id) {
            return [1,2,3,4,5].map(v => `
                <label class="cursor-pointer group relative">
                    <input type="radio" name="${id}" value="${v}" class="rating-radio" onchange="saveDraft()">
                    <div class="rating-box">${v}</div>
                </label>`).join('');
        }

        function initAuditForm() {
            const zSel = document.getElementById('zoneSelect');
            zSel.innerHTML = '<option value="">-- กรุณาเลือกเขต --</option>';
            zoneList.forEach(z => { zSel.innerHTML += `<option value="${z}">${z}</option>`; });
            
            // Setup Rating Areas
            const ratings = ['rate_person', 'rate_sale', 'rate_k_m', 'rate_k_ctv', 'rate_k_hl', 'rate_k_promo', 
                             'rate_area_target', 'rate_c_branch', 'rate_c_desk', 'rate_c_coffee', 'rate_c_toilet', 'rate_c_storage', 'rate_c_back'];
            ratings.forEach(id => { document.getElementById(id).innerHTML = genRating(id); });

            currentAuditImages = {}; 
            // Render Dynamic Questions (Part 4) - BEAUTIFIED & ORGANIZED
            document.getElementById('questionsContainer').innerHTML = questions.map((q, i) => `
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 hover:border-pink-300 transition">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-bold text-slate-800 text-base flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-sm font-bold shadow-sm">${i+1}</span> 
                            ${q.title}
                        </h5>
                    </div>
                    <div class="ml-0 md:ml-11 flex flex-col md:flex-row gap-4 items-start md:items-center">
                        <div class="switch-wrapper">
                             <label>
                                <input type="radio" name="${q.id}" value="ผ่าน" class="switch-radio" onchange="saveDraft()">
                                <div class="switch-label text-slate-500"><i class="fa-solid fa-check"></i> ผ่าน</div>
                             </label>
                             <label>
                                <input type="radio" name="${q.id}" value="ไม่ผ่าน" class="switch-radio" onchange="saveDraft()">
                                <div class="switch-label text-slate-500"><i class="fa-solid fa-xmark"></i> ไม่ผ่าน</div>
                             </label>
                        </div>
                        <input type="text" id="note_${q.id}" placeholder="ระบุหมายเหตุ..." class="form-input flex-1 bg-white" oninput="saveDraft()">
                        ${q.allowImage ? `<div class="flex items-center gap-2"><label for="file_${q.id}" class="cursor-pointer bg-white border border-slate-300 px-3 py-2 text-xs font-bold rounded-lg hover:border-primary hover:text-primary transition flex items-center gap-2 text-slate-500 shadow-sm whitespace-nowrap"><i class="fa-solid fa-camera"></i> หลักฐาน</label><input type="file" id="file_${q.id}" accept="image/*" class="hidden" onchange="handleImageSelect(this, '${q.id}')"><span id="file_status_${q.id}" class="text-xs font-bold"></span></div>` : ''}
                    </div>
                </div>`).join('');
        }

        // Collect all form data including inputs, selects, textareas, and ratings
        function collectFormData() {
            const formData = {};
            // 1. Inputs/Selects/Textareas
            const elements = document.getElementById('auditForm').querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select, textarea');
            elements.forEach(el => { if(el.id) formData[el.id] = el.value; });
            
            // 2. Ratings (Radio Groups)
            const ratings = ['rate_person', 'rate_sale', 'rate_k_m', 'rate_k_ctv', 'rate_k_hl', 'rate_k_promo', 
                             'rate_area_target', 'rate_c_branch', 'rate_c_desk', 'rate_c_coffee', 'rate_c_toilet', 'rate_c_storage', 'rate_c_back'];
            ratings.forEach(id => {
                const checked = document.querySelector(`input[name="${id}"]:checked`);
                if(checked) formData[id] = checked.value;
            });

            // 3. Dynamic Questions
            formData.dynamic = {};
            questions.forEach(q => {
                const checked = document.querySelector(`input[name="${q.id}"]:checked`);
                if(checked) formData.dynamic[q.id] = checked.value;
                formData.dynamic[`note_${q.id}`] = document.getElementById(`note_${q.id}`).value;
            });
            
            return formData;
        }

        function saveDraft() {
            const data = collectFormData();
            localStorage.setItem(STORAGE.DRAFT, JSON.stringify(data));
        }

        function checkDraft() {
            const draft = localStorage.getItem(STORAGE.DRAFT);
            if(draft) { document.getElementById('draftNotice').classList.remove('hidden'); }
        }

        function restoreDraft(data) {
            document.getElementById('zoneSelect').value = data['zoneSelect']; 
            handleZoneChange(); 
            setTimeout(() => { 
                // Restore all inputs
                for (const key in data) {
                    if (key === 'dynamic') continue;
                    const el = document.getElementById(key);
                    if (el) {
                        el.value = data[key];
                    } else {
                        // Try radio buttons
                        const radio = document.querySelector(`input[name="${key}"][value="${data[key]}"]`);
                        if(radio) radio.checked = true;
                    }
                }
                // Restore Dynamic
                if(data.dynamic) {
                    Object.keys(data.dynamic).forEach(key => {
                        if(key.startsWith('note_')) { const el = document.getElementById(key); if(el) el.value = data.dynamic[key]; } 
                        else { const el = document.querySelector(`input[name="${key}"][value="${data.dynamic[key]}"]`); if(el) el.checked = true; }
                    });
                }
                document.getElementById('draftNotice').classList.add('hidden');
            }, 200);
        }

        function clearDraft() { localStorage.removeItem(STORAGE.DRAFT); document.getElementById('draftNotice').classList.add('hidden'); document.getElementById('auditForm').reset(); }
        function handleImageSelect(input, qId) { 
            if (input.files && input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = function(e) { 
                    currentAuditImages[qId] = e.target.result; 
                    document.getElementById(`file_status_${qId}`).innerHTML = `<i class="fa-solid fa-circle-check text-green-500 text-lg"></i>`; 
                    saveDraft(); 
                }; 
                reader.readAsDataURL(input.files[0]); 
            } 
        }
        function handleZoneChange() { const z = document.getElementById('zoneSelect').value; const bSel = document.getElementById('branchSelect'); bSel.innerHTML = '<option value="">-- กรุณาเลือกสาขา --</option>'; if (z && branchData[z]) { bSel.disabled = false; branchData[z].forEach(b => { const display = b.id && b.id !== '-' ? `[${b.id}] ${b.name}` : b.name; bSel.innerHTML += `<option value="${display}">${display}</option>`; }); } else { bSel.disabled = true; } saveDraft(); }
        function getLocation() { const gpsInput = document.getElementById('gpsCoords'); gpsInput.value = "กำลังค้นหา..."; if(navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { gpsInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`; }, err => { gpsInput.value = ""; showPopup('error', 'GPS Error', err.message); }); } else { showPopup('error', 'Error', "Browser ไม่รองรับ GPS"); } }

        async function submitAudit(e) {
            e.preventDefault();
            const gps = document.getElementById('gpsCoords').value;
            if(!gps || gps === "กำลังค้นหา..." || gps === "") { showPopup('warning', 'แจ้งเตือน', 'กรุณาระบุพิกัด GPS'); return; }
            
            const rawData = collectFormData();
            // Transform rawData into Details Array for backend compatibility
            const details = [];
            
            // Map Static Fields to Details Array
            const fieldMap = {
                'f_site': 'ไซต์สาขา', 'f_age': 'อายุสาขา', 'f_target': 'เป้าสาขา', 'f_actual': 'ยอดทำได้จริง',
                'emp_name': 'ชื่อพนักงาน', 'rate_person': 'ประเมินบุคลิก', 'rate_sale': 'ทักษะการขาย',
                'area_comp_near': 'คู่แข่งติดกัน', 'area_sign': 'สภาพป้าย'
                // Add more mappings as needed for critical report fields
            };

            // Loop through all collected data to create a flat report
            for (const key in rawData) {
                if (key === 'dynamic' || key === 'zoneSelect' || key === 'branchSelect' || key === 'summaryComment') continue;
                // Use label mapping or key name
                const label = fieldMap[key] || key;
                details.push({ q: label, res: rawData[key], note: '' });
            }

            // Add Dynamic Questions
            if(rawData.dynamic) {
                questions.forEach(q => {
                    if(rawData.dynamic[q.id]) {
                        details.push({ q: q.title, res: rawData.dynamic[q.id], note: rawData.dynamic[`note_${q.id}`], image: currentAuditImages[q.id] || "" });
                    }
                });
            }

            const record = { 
                id: Date.now().toString(), 
                date: new Date().toLocaleString('th-TH'), 
                auditor: currentUser.name, 
                zone: document.getElementById('zoneSelect').value, 
                branch: document.getElementById('branchSelect').value, 
                gps: gps, 
                result: details.some(d => d.res === 'ไม่ผ่าน' || d.res === '1' || d.res === 'ชำรุด') ? 'ไม่ผ่าน' : 'ผ่าน', // Simple logic
                summary: document.getElementById('summaryComment').value, 
                signature: document.getElementById('signaturePad').toDataURL(), 
                details: details 
            };
            
            toggleLoading(true, "กำลังบันทึกข้อมูล...");
            const res = await callAPI('submitAudit', { record });
            toggleLoading(false);
            if (res.success) { Swal.fire('บันทึกสำเร็จ!', '', 'success'); clearDraft(); document.getElementById('branchSelect').disabled = true; currentAuditImages = {}; switchView('view-history'); } 
            else { showPopup('error', 'เกิดข้อผิดพลาด', res.message); }
        }

        // --- Signature ---
        function initSignature() {
            const canvas = document.getElementById('signaturePad');
            setTimeout(() => {
                if(!canvas.parentElement) return;
                const resizeCanvas = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; const ctx = canvas.getContext('2d'); ctx.strokeStyle = "#1e293b"; ctx.lineWidth = 2; ctx.lineCap = "round"; };
                resizeCanvas(); window.addEventListener('resize', resizeCanvas);
                const ctx = canvas.getContext('2d'); ctx.strokeStyle = "#1e293b"; ctx.lineWidth = 2; ctx.lineCap = "round";
                let drawing = false;
                const getPos = (e) => { const r = canvas.getBoundingClientRect(); return { x: (e.clientX||e.touches[0].clientX)-r.left, y: (e.clientY||e.touches[0].clientY)-r.top }; }
                const start = (e) => { drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); e.preventDefault(); }
                const move = (e) => { if(!drawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); e.preventDefault(); }
                const end = () => drawing=false;
                canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
                canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', end);
            }, 500);
        }
        function clearSignature() { const c = document.getElementById('signaturePad'); c.getContext('2d').clearRect(0, 0, c.width, c.height); }

        // --- Questions Config ---
        function renderQuestionsConfig() { document.getElementById('questionsListConfig').innerHTML = questions.map(q => `<div class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg shadow-sm"><div><div class="font-bold text-slate-700">${q.title}</div><div class="text-xs ${q.allowImage ? 'text-green-600' : 'text-slate-400'} mt-1"><i class="fa-solid fa-camera"></i> ${q.allowImage ? 'รองรับรูปภาพ' : 'ไม่ใช้รูปภาพ'}</div></div><button onclick="removeQ('${q.id}')" class="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded hover:bg-red-100 transition"><i class="fa-solid fa-trash"></i></button></div>`).join(''); }
        function handleAddQuestion(e) { e.preventDefault(); const title = e.target.qTitle.value; const allowImg = e.target.qAllowImg.checked; questions.push({ id: 'q' + Date.now(), title: title, allowImage: allowImg }); localStorage.setItem(STORAGE.QUESTIONS, JSON.stringify(questions)); e.target.reset(); renderQuestionsConfig(); showPopup('success', 'สำเร็จ', "เพิ่มหัวข้อเรียบร้อยแล้ว"); }
        function removeQ(id) { Swal.fire({ title: 'ยืนยันการลบ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ลบ' }).then((result) => { if (result.isConfirmed) { questions = questions.filter(q => q.id !== id); localStorage.setItem(STORAGE.QUESTIONS, JSON.stringify(questions)); renderQuestionsConfig(); Swal.fire('ลบสำเร็จ!', '', 'success'); } }) }
        function resetQuestions() { Swal.fire({ title: 'คืนค่าเริ่มต้น?', icon: 'warning', showCancelButton: true, confirmButtonText: 'รีเซ็ต' }).then((result) => { if (result.isConfirmed) { questions = defaultQuestions; localStorage.setItem(STORAGE.QUESTIONS, JSON.stringify(questions)); renderQuestionsConfig(); } }) }

        // --- Analytics ---
        async function fetchAnalytics() {
            const ctx1 = document.getElementById('trendChart');
            const ctx2 = document.getElementById('failChart');
            if(!ctx1 || !ctx2) return; 
            if(window.trendChartInstance) window.trendChartInstance.destroy();
            if(window.failChartInstance) window.failChartInstance.destroy();
            const res = await callAPI('getAnalytics');
            if(res.success) {
                const { trend, failed } = res.data;
                window.trendChartInstance = new Chart(ctx1, { type: 'line', data: { labels: trend.map(t => t.month), datasets: [{ label: 'คะแนนเฉลี่ย (%)', data: trend.map(t => t.score), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } } });
                window.failChartInstance = new Chart(ctx2, { type: 'bar', data: { labels: failed.map(f => f.q.substring(0, 20) + '...'), datasets: [{ label: 'จำนวนครั้งที่ตก', data: failed.map(f => f.count), backgroundColor: '#ef4444' }] }, options: { indexAxis: 'y', responsive: true } });
            }
        }

        // --- Export ---
        function downloadPDF() { const element = document.getElementById('detailContent'); const opt = { margin: 10, filename: 'audit-report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save(); }
        function printReport() { const content = document.getElementById('detailContent').innerHTML; const printArea = document.getElementById('print-area'); printArea.innerHTML = `<div class="p-8"><h1 class="text-2xl font-bold mb-4 text-center">รายงานการตรวจสอบมาตรฐานสาขา</h1>${content}</div>`; window.print(); }
        
        // --- History ---
        async function fetchHistory(shouldRender = true) { 
            if(shouldRender) toggleLoading(true, "กำลังโหลดประวัติ...");
            const res = await callAPI('getHistory'); 
            if(shouldRender) toggleLoading(false);
            if(res.success) { 
                auditRecords = res.data; 
                updateDashboardCounts(); // Sync dashboard
                if(shouldRender) renderHistoryTable(auditRecords);
            } 
        }

        async function deleteAudit(id) {
             const confirm = await Swal.fire({ title: 'ยืนยันลบประวัติ?', text: "ข้อมูลจะถูกลบถาวรจากฐานข้อมูล", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ลบข้อมูล' });
             if(confirm.isConfirmed) {
                 toggleLoading(true, "กำลังลบข้อมูล...");
                 const res = await callAPI('deleteAudit', { auditId: id });
                 toggleLoading(false);
                 if(res.success) { Swal.fire('ลบสำเร็จ', 'ข้อมูลถูกลบเรียบร้อย', 'success'); fetchHistory(); } else { showPopup('error', 'ผิดพลาด', res.message); }
             }
        }

        function openDetail(id) { 
            const rec = auditRecords.find(r => r.id == id);
            if(!rec) return; 
            document.getElementById('detailContent').innerHTML = `
                <div class="mb-4 bg-slate-50 p-3 rounded border border-slate-100"><strong>สาขา:</strong> ${rec.branch} (${rec.zone})<br><strong>วันที่:</strong> ${rec.date} <br><strong>ผู้ตรวจ:</strong> ${rec.auditor}</div>
                <table class="w-full text-sm border">
                    <thead class="bg-slate-100"><tr><th class="p-2 border">หัวข้อ</th><th class="p-2 border">ผล/ข้อมูล</th><th class="p-2 border">หมายเหตุ/รูปภาพ</th></tr></thead>
                    <tbody>${rec.details.map(d => `<tr><td class="p-2 border">${d.q}</td><td class="p-2 border text-center font-bold ${d.res==='ไม่ผ่าน'?'text-red-500':'text-slate-700'}">${d.res||'-'}</td><td class="p-2 border text-center">${d.image && d.image.startsWith('http') ? `<img src="${d.image}" class="h-16 inline-block rounded border">` : (d.note || '-')}</td></tr>`).join('')}</tbody>
                </table>
                <div class="mt-4 border p-3 rounded bg-white"><strong class="text-xs text-slate-400 uppercase">สรุป:</strong> <br>${rec.summary||'-'}</div>
                ${rec.signature ? `<div class="mt-4 text-right"><img src="${rec.signature}" class="h-20 border inline-block rounded"></div>` : ''}
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        // --- User Management (Original) ---
        async function fetchUsers() { 
            toggleLoading(true, "กำลังโหลดรายชื่อ...");
            const res = await callAPI('getUsers'); 
            toggleLoading(false);
            if(res.success) { 
                document.getElementById('userListContainerBody').innerHTML = res.data.map(u => `
                <tr class="border-b">
                    <td class="p-3 font-bold">${u.user} <div class="text-xs text-slate-400 font-normal">${u.name}</div></td>
                    <td class="p-3"><span class="bg-slate-100 px-2 py-1 rounded text-xs uppercase">${u.role}</span></td>
                    <td class="p-3 text-right">
                        <button onclick="openEditUser('${u.user}', '${u.name}', '${u.role}')" class="text-blue-500 hover:text-blue-700 mx-2"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteUser('${u.user}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join(''); 
            } 
        }

        function openEditUser(user, name, role) {
            document.getElementById('editUsername').value = user;
            document.getElementById('editName').value = name;
            document.getElementById('editRole').value = role;
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        async function handleEditUserSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            toggleLoading(true, "กำลังบันทึกข้อมูล...");
            
            const res = await callAPI('editUser', {
                user: formData.get('user'),
                name: formData.get('name'),
                role: formData.get('role'),
                pass: formData.get('pass')
            });

            toggleLoading(false);
            if(res.success) {
                document.getElementById('editUserModal').classList.add('hidden');
                Swal.fire('สำเร็จ', 'แก้ไขข้อมูลผู้ใช้เรียบร้อย', 'success');
                fetchUsers();
            } else {
                showPopup('error', 'ผิดพลาด', res.message);
            }
        }
        
        async function handleAddUser(e) { 
            e.preventDefault(); 
            toggleLoading(true, "กำลังเพิ่มผู้ใช้...");
            const res = await callAPI('addUser', { user: e.target.newUsername.value, pass: e.target.newPassword.value, name: e.target.newName.value, role: e.target.newRole.value }); 
            toggleLoading(false);
            if(res.success){ showPopup('success', 'สำเร็จ', 'เพิ่มผู้ใช้เรียบร้อย'); fetchUsers(); e.target.reset(); } 
            else { showPopup('error', 'ผิดพลาด', res.message); }
        }
        
        async function deleteUser(u) { 
            const confirm = await Swal.fire({ title: 'ยืนยันลบผู้ใช้?', text: u, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ลบ' });
            if(confirm.isConfirmed) { toggleLoading(true, "กำลังลบผู้ใช้..."); await callAPI('deleteUser', {targetUser: u}); toggleLoading(false); fetchUsers(); } 
        }

        async function fetchLogs() { 
            toggleLoading(true, "กำลังโหลด Log...");
            const res = await callAPI('getLogs'); 
            toggleLoading(false);
            if(res.success && res.data.length > 0) { document.getElementById('systemLogsContainer').innerHTML = res.data.map(l => `<tr class="border-b"><td class="px-6 py-3 text-slate-500">${l.timestamp}</td><td class="px-6 py-3 font-bold">${l.user}</td><td class="px-6 py-3">${l.role}</td><td class="px-6 py-3">${l.action}</td><td class="px-6 py-3 text-xs font-mono">${l.details}</td></tr>`).join(''); } 
        }
    </script>
</body>
</html>
